<?xml version="1.0" encoding="utf-8" ?>

<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                   assembly="Zbang.Zbox.ViewModel"
                   namespace="Zbang.Zbox.ViewModel.DTOs">


  <resultset name="ItemDto">
    <return-scalar column="id" type="long"/>
    <return-scalar column="Name" type="string"/>
    <return-scalar column="OwnerId" type="long"/>
    <return-scalar column="Owner" type="string"/>
    <return-scalar column="UserUrl" type="string" />
    <return-scalar column="Thumbnail" type="string"/>
    <return-scalar column="Discriminator" type="string"/>
    <return-scalar column="TabId" type="string"/>
    <return-scalar column="NumOfViews" type="int"/>
    <return-scalar column="Rate" type="double"/>
    <return-scalar column="Sponsored" type="bool" />
    <return-scalar column="Description" type="string"/>
    <return-scalar column="BlobName" type="string"/>
    <return-scalar column="NumOfDownloads" type="int"/>
    <return-scalar column="Date" type="DateTime"/>
    <return-scalar column="CommentsCount" type="int"/>
  </resultset>

  <resultset name="QuizDto">
    <return-scalar column="Id" type="long"/>
    <return-scalar column="OwnerId" type="long"/>
    <return-scalar column="Owner" type="string"/>
    <return-scalar column="UserUrl" type="string"/>
    <return-scalar column="Name" type="string"/>
    <return-scalar column="Publish" type="bool"/>
    <return-scalar column="Rate" type="double"/>
    <return-scalar column="NumOfViews" type="int"/>
    <return-scalar column="Description" type="string"/>
    <return-scalar column="CommentsCount" type="int"/>
    <return-scalar column="Date" type="DateTime"/>
  </resultset>




  <resultset name="ItemWithDetailDto">
    <return-scalar column="Id" type="long"/>
    <return-scalar column="UpdateTime" type="DateTime"/>
    <return-scalar column="Name" type="string"/>
    <return-scalar column="UserName" type="string"/>
    <return-scalar column="UserId" type="long"/>
    <return-scalar column="UserImage" type="string"/>
    <return-scalar column="Blob" type="string"/>
    <return-scalar column="Discriminator" type="string"/>
    <return-scalar column="NumberOfViews" type="int"/>
    <return-scalar column="NumberOfDownloads" type="int"/>
    <return-scalar column="Rate" type="double"/>
    <return-scalar column="BoxId" type="long"/>
    <return-scalar column="BoxName" type="string"/>
    <return-scalar column="Country" type="string"/>
    <return-scalar column="UniName" type="string"/>
    <return-scalar column="Description" type="string"/>
    <return-scalar column="BoxUrl" type="string"/>
  </resultset>

  <!--Used in box page to get item section-->
  <!--TODO: AGGREGATE BOX ITEMS-->
  <sql-query name="GetBoxItemDtosByBoxId2" resultset-ref="ItemDto" read-only="1">
    <![CDATA[
    select
    i.itemid as Id,
    i.Name as Name,
    i.userid as OwnerId,
    u.UserName as Owner,
    u.Url as UserUrl,
    i.thumbnailurl as Thumbnail,
    i.Discriminator as Discriminator,
    i.ItemTabId as TabId,
	  i.NumberOfViews as NumOfViews,
    i.rate as Rate,
    i.sponsored as Sponsored,
    i.content as Description,
    i.BlobName as BlobName,
    i.NumberOfDownloads as NumOfDownloads,
    i.creationTime as Date,
		i.numberofcomments as commentsCount
    from zbox.item i join zbox.users u on i.UserId = u.UserId
    where i.IsDeleted = 0
    and i.BoxId = :BoxId
    and (:TabId is null or i.ItemTabId = :TabId)
    order by i.itemid desc
    ]]>
  </sql-query>
  <sql-query name="GetBoxQuiz" read-only="1" resultset-ref="QuizDto">
    <![CDATA[
    select 
    id as Id, 
    q.userid as OwnerId,
    u.UserName as Owner,
    u.Url as UserUrl,
    name as Name,
    Publish,
    rate as Rate,
    NumberOfViews as NumOfViews,
    Content as Description,
    NumberOfComments as commentsCount,
    q.CreationTime as Date
    from zbox.quiz q
    join zbox.Users u on u.userid = q.UserId
    where boxid = :BoxId
    ]]>
  </sql-query>



  <!--Temp for dbi-->
  <query name="GetItemIdByBlobId">
    <![CDATA[
      select f.Id from File f where f.ItemContentUrl = :BlobName
    ]]>
  </query>

  <!--Used for item page-->
  <sql-query name="GetItem" resultset-ref="ItemWithDetailDto" read-only="1">
    <![CDATA[
    select i.itemid as id, i.UpdateTime as updateTime,
    i.Name as name,
    i.BlobName as blob,
    i.Discriminator +'WithDetail' as Discriminator,
    u.UserName as userName, 
    u.userid as userId,
    u.UserImage as userImage,
    coalesce(	i.NumberOfViews,0) as numberOfViews,
    i.numberofdownloads as numberOfDownloads,
    i.rate as Rate,
    i.boxid as BoxId,
    b.BoxName as BoxName,
    
    u2.Country as Country, 
    u2.UniversityName as UniName,
    content as Description,
    b.Url as BoxUrl
    
    from zbox.Item i
    join zbox.Users u on u.UserId = i.UserId
    join zbox.box b on b.BoxId=i.BoxId
    join zbox.users u2 on u2.UserId = b.OwnerId
    where i.ItemId = :ItemId
    and i.IsDeleted = 0 ;
    ]]>
  </sql-query>


</hibernate-mapping>