<?xml version="1.0" encoding="utf-8" ?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" schema="Zbox"
                   assembly="Zbang.Zbox.ViewModel"
                   namespace="Zbang.Zbox.ViewModel.DTOs">


  <resultset name="UserRelationType">
    <return-scalar column="Type" type="Zbang.Zbox.Infrastructure.Enums.UserRelationshipType,Zbang.Zbox.Infrastructure"/>
  </resultset>
 
 

  

 
  <sql-query name="GetUserRelationToBox" read-only="1" resultset-ref="UserRelationType">
    <![CDATA[
    select top(1) type from (
     select usertype as type from zbox.UserBoxRel 
        where boxid = :BoxId and userid = :UserId
        union
        select 1 as type from zbox.Message
        where TypeOfMsg = 2 and RecepientId = :UserId and BoxId = :BoxId
	    and isActive = 1) t
	    order by 1 desc
    ]]>
  </sql-query>


  <!--account settings-->
  <query name="GetUserAccountSettings">
    <![CDATA[
    select 
    
    COALESCE(u.FirstName,u.Name) as FirstName,
    u.MiddleName as MiddleName,
    u.LastName as LastName,
    
    u.ImageLarge as Image, 
    coalesce( v.OrgName , v.UniversityName) as University,
    v.LargeImage as UniversityPic,
    u.Email as Email,
    u.Culture as Language,
    u.Quota.AllocatedSize as AllocatedSize, u.Quota.UsedSpace as UsedSpace
    from User u left join u.University v
    where u.Id = :UserId
    ]]>
  </query>

  <!--End Account settings-->
  

</hibernate-mapping>