
﻿@{
    Layout = null;
}
<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Terms</title>
    <link rel="stylesheet" type="text/css" href="/Content/termSearch.css" />
</head>
<body>
    <div>
        <div class="top">
            <h1>Enter Terms to Compare Google Knowledge with Wikipedia Results</h1>
            <div class="search">
                <input type="text" name="term" id="term" value="" />
                <input type="submit" id="submit" value="search" onclick="hello()" />
            </div>
        </div>
        <h2 hidden id="loader">Loading...</h2>
        <table hidden>
            <thead>
                <tr>
                    <th>Google knowledge</th>
                    <th>WikiPedia</th>
                </tr>
            </thead>
            <tr>
                <td id="googleResult"></td>
                <td id="wikiResult"></td>
            </tr>
        </table>

    </div>
    <script src="/Scripts/jquery-2.2.4.min.js"></script>
    <script>
        document.getElementById('term').addEventListener('keypress', function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                document.getElementById('submit').click()
            }
        });

        function createCORSRequest(method, url) {
            var xhr = new XMLHttpRequest();
            if ("withCredentials" in xhr) {

                // Check if the XMLHttpRequest object has a "withCredentials" property.
                // "withCredentials" only exists on XMLHTTPRequest2 objects.
                xhr.open(method, url, true);

            } else if (typeof XDomainRequest != "undefined") {

                // Otherwise, check if XDomainRequest.
                // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
                xhr = new XDomainRequest();
                xhr.open(method, url);

            } else {

                // Otherwise, CORS is not supported by the browser.
                xhr = null;

            }
            return xhr;
        }
        //$(document).ready(funcion(){
        function hello() {

            document.getElementsByTagName("table")[0].hidden = true
            document.getElementById("loader").hidden = false
            //document.getElementsByName("term")
                var service_url = 'https://kgsearch.googleapis.com/v1/entities:search';
                var wiki_url = 'https://en.wikipedia.org/w/api.php';
                var query = document.getElementById("term").value;

            var params = {
                'query': query,
                'limit': 1,
                'indent': true,
                'key': 'AIzaSyASDp6MLs6mqoppPkkKUN_yoiE8WZjesow'
            };
            var paramsWiki = {
                'search': query,
                'limit': 1,
                'action': 'query',
                'prop': 'extract',
            };
                $.getJSON(service_url + '?callback=?', params, function (response) {
                    var itemList = response.itemListElement;
                    var s;
                    if (itemList.length === 0) {
                        s = "<h2 class='error'>No google knowledge results found</h2>"
                    }
                    else {
                        s = "<h2>Title:</h2><p>" + response.itemListElement[0].result.name + "</p>";
                        if (response.itemListElement[0].result.detailedDescription){
                           s+= "<h2>Description:</h2><p>" + response.itemListElement[0].result.detailedDescription.articleBody + "</p>"
                        }
                        if (response.itemListElement[0].result.image) {
                            s+="<h2>Image</h2>:<img src='" + response.itemListElement[0].result.image.contentUrl + "'/>"
                        }
                    }

                document.getElementById("googleResult").innerHTML = "<p>" + s + "</p>";
                document.getElementsByTagName("table")[0].hidden = false
                document.getElementById("loader").hidden = true
                    //JSON.stringify(JSON.parse(response), null, "\t");
            });

            //preSearch
                var preSearch = "http://en.wikipedia.org/w/api.php?action=query&format=json&list=search&meta=&srsearch=" + query;
            var accurateTerm;
            $.ajax({
                url: preSearch,
                type: "GET",
                dataType: "jsonp",
                xhrFields: {
                    withCredentials: false
                },
                success: function (data, textStatus, jqXHR) {
                    if (data.query.search.length) {
                        accurateTerm = data.query.search[0].title;
                    }
                    else if (data.query.searchinfo.suggestion) {
                        accurateTerm = data.query.searchinfo.suggestion;
                    }
                }
            }).done(function () {
                $.ajax({
                    type: "GET",
                    url: "http://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts%7Cpageimages%7Cpageprops%7Cpageterms&meta=&exsentences=2&pilicense=any&piprop=original&titles=" + accurateTerm,
                    xhrFields: {
                        withCredentials: false
                    },
                    dataType: "jsonp",
                    success: function (data, textStatus, jqXHR) {
                        console.log("data: " + data.query.pages[Object.keys(data.query.pages)[0]])
                        var terms = data.query.pages[Object.keys(data.query.pages)[0]].terms
                        var title = data.query.pages[Object.keys(data.query.pages)[0]].title
                        var s;
                        if (typeof (terms) == 'undefined'||title=='Undefined') {
                            s = "<h2 class='error'>No wikipedia results found</h2>"
                        }
                        else {
                            var source;
                            if (data.query.pages[Object.keys(data.query.pages)[0]].original) source = data.query.pages[Object.keys(data.query.pages)[0]].original.source;
                            s = "<h2>Title:</h2><p>" + data.query.pages[Object.keys(data.query.pages)[0]].title + "</p>";
                            if (terms.description&&terms.description.length) {
                                s += "<h2>Description:</h2><p>" + terms.description[0] + "</p>";
                            }
                            
                            s+="<h2>Extract:</h2><p>" + data.query.pages[Object.keys(data.query.pages)[0]].extract;
                            if (source) {
                               s+= "</p>" + "<h2>Image:</h2><img src='" + source + "'/>"
                            }
                        }
                        document.getElementById("wikiResult").innerHTML = "<p>" + s + "</p>";
                        document.getElementsByTagName("table")[0].hidden = false
                        document.getElementById("loader").hidden = true
                    },
                    error: function (errorMessage) {
                    }
                });
            });
            //$.ajax({
            //    url: wiki_url,
            //    data: paramsWiki,
            //    dataType: 'jsonfm',
            //    type: 'GET',
            //    success: function (data) {
            //        // do something with data
            //        document.getElementById("wikiResult").innerHTML = JSON.stringify(data, null, 2);
            //    }
            //});
            return false;
            }
        //})
        //    document.getElementById("submit").click(hello);
        //)
    </script>
</body>
</html>
