(function(n){"use strict";function r(){return"ondrag"in document.createElement("a")}function i(n){typeof n.dataTransfer!="undefined"&&n.dataTransfer.dropEffect==="none"&&(n.dataTransfer.effectAllowed==="copy"||n.dataTransfer.effectAllowed==="move"?n.dataTransfer.dropEffect=n.dataTransfer.effectAllowed:(n.dataTransfer.effectAllowed==="copyMove"||n.dataTransfer.effectAllowed==="copymove")&&(n.dataTransfer.dropEffect=n.ctrlKey?"copy":"move"))}if(!r()){n.module("ang-drag-drop",[]);return}window.jQuery&&-1===window.jQuery.event.props.indexOf("dataTransfer")&&window.jQuery.event.props.push("dataTransfer");var t=n.module("ang-drag-drop",[]);t.directive("uiDraggable",["$parse","$rootScope","$dragImage",function(t,r,u){return function(f,e,o){function h(n){var u,c,l;console.log("here");s=!0;setTimeout(function(){e.unbind("$destroy",h)},0);u=o.dragChannel||"defaultchannel";r.$broadcast("ANGULAR_DRAG_END",n,u);i(n);n.dataTransfer&&n.dataTransfer.dropEffect!=="none"?o.onDropSuccess&&(c=t(o.onDropSuccess),f.$evalAsync(function(){c(f,{$event:n})})):n.dataTransfer&&n.dataTransfer.dropEffect==="none"&&o.onDropFailure&&(l=t(o.onDropFailure),f.$evalAsync(function(){l(f,{$event:n})}));e.removeClass(v)}function b(i,r){var u;i&&i.dataTransfer&&i.dataTransfer.setDragImage&&(u=t(r),f.$apply(function(){var t=u(f,{$event:i}),r;t&&n.isString(t)&&(r=document.getElementById(t),r)&&i.dataTransfer.setDragImage(r,0,0)}))}function p(i){var g=!l||y.classList.contains(a),s,c,p,w,k;if(g){s=o.dragChannel||"defaultchannel";c="";o.drag&&(c=f.$eval(o.drag));p=o.dragImage||null;e.addClass(v);e.bind("$destroy",h);w=!(document.uniqueID||window.opera);p&&w?(k=t(o.dragImage),f.$apply(function(){var t=k(f,{$event:i}),r,e;t&&(n.isString(t)&&(t=u.generate(t)),t.image&&(r=t.xOffset||0,e=t.yOffset||0,i.dataTransfer.setDragImage(t.image,r,e)))})):o.dragImageElementId&&b(i,o.dragImageElementId);var nt={x:i.originalEvent.offsetX,y:i.originalEvent.offsetY},d={data:c,channel:s,offset:nt},tt=n.toJson(d);i.dataTransfer.setData("text",tt);i.dataTransfer.effectAllowed="copyMove";r.$broadcast("ANGULAR_DRAG_START",i,s,d)}else i.preventDefault()}function w(n){s=!0;n.originalEvent.clientY<150&&(s=!1,c(-1));n.originalEvent.clientY>$(window).height()-150&&(s=!1,c(1))}function c(n){var t=$(window).scrollTop();$(window).scrollTop(t+n);s||setTimeout(function(){c(n)},20)}var l=!1,s=!0,a,v=o.draggingClass||"on-dragging",y;e.attr("draggable",!1);f.$watch(o.uiDraggable,function(n){n?(e.attr("draggable",n),e.bind("dragend",h),e.bind("dragstart",p),e.bind("drag",w)):(e.removeAttr("draggable"),e.unbind("dragend",h),e.unbind("dragstart",p),e.unbind("drag",w))});n.isString(o.dragHandleClass)&&(l=!0,a=o.dragHandleClass.trim()||"drag-handle",e.bind("mousedown",function(n){y=n.target}))}}]);t.directive("uiOnDrop",["$parse","$rootScope",function(t,r){return function(u,f,e){function d(n){for(var i={x:n.originalEvent.offsetX,y:n.originalEvent.offsetY},t=n.originalEvent.target;t!==f[0];)if(i.x=i.x+t.offsetLeft,i.y=i.y+t.offsetTop,t=t.offsetParent,!t)return null;return i}function v(n){n.preventDefault&&n.preventDefault();n.stopPropagation&&n.stopPropagation();var i=t(e.uiOnDragOver);return u.$evalAsync(function(){i(u,{$event:n,$channel:s})}),!1}function y(n){n.preventDefault&&n.preventDefault();n.stopPropagation&&n.stopPropagation();c--;c===0&&(u.$evalAsync(function(){k(u,{$event:n,$channel:s})}),f.addClass(h),f.removeClass(l));var i=t(e.uiOnDragLeave);u.$evalAsync(function(){i(u,{$event:n,$channel:s})})}function p(n){n.preventDefault&&n.preventDefault();n.stopPropagation&&n.stopPropagation();c===0&&(u.$evalAsync(function(){b(u,{$event:n,$channel:s})}),f.removeClass(h),f.addClass(l));c++;var i=t(e.uiOnDragEnter);u.$evalAsync(function(){i(u,{$event:n,$channel:s})});r.$broadcast("ANGULAR_HOVER",a)}function w(r){var o,s,l,a;r.preventDefault&&r.preventDefault();r.stopPropagation&&r.stopPropagation();o=r.dataTransfer.getData("text");o=n.fromJson(o);s=d(r);l=s?{x:s.x-o.offset.x,y:s.y-o.offset.y}:null;i(r);a=t(e.uiOnDrop);u.$evalAsync(function(){a(u,{$data:o.data,$event:r,$channel:o.channel,$position:l})});f.removeClass(h);c=0}function g(n,t){if(t==="*")return!0;var i=new RegExp("(\\s|[,])+("+n+")(\\s|[,])+","i");return i.test(","+t+",")}function o(n){return n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation(),n.dataTransfer.dropEffect="none",!1}var c=0,s=e.dropChannel||"defaultchannel",a="",h=e.dragEnterClass||"on-drag-enter",l=e.dragHoverClass||"on-drag-hover",b=t(e.onDragEnter),k=t(e.onDragLeave),nt=r.$on("ANGULAR_DRAG_START",function(n,i,r,c){var l,b;a=r;l=!0;g(r,s)||(l=!1);l&&e.dropValidate&&(b=t(e.dropValidate),l=b(u,{$drop:{scope:u,element:f},$event:i,$data:c.data,$channel:c.channel}));l?(f.bind("dragover",v),f.bind("dragenter",p),f.bind("dragleave",y),f.bind("drop",w),f.addClass(h)):(f.bind("dragover",o),f.bind("dragenter",o),f.bind("dragleave",o),f.bind("drop",o),f.removeClass(h))}),tt=r.$on("ANGULAR_DRAG_END",function(){f.unbind("dragover",v);f.unbind("dragenter",p);f.unbind("dragleave",y);f.unbind("drop",w);f.removeClass(l);f.removeClass(h);f.unbind("dragover",o);f.unbind("dragenter",o);f.unbind("dragleave",o);f.unbind("drop",o)});u.$on("$destroy",function(){nt();tt()});e.$observe("dropChannel",function(n){n&&(s=n)})}}]);t.constant("$dragImageConfig",{height:20,width:200,padding:10,font:"bold 11px Arial",fontColor:"#eee8d5",backgroundColor:"#93a1a1",xOffset:0,yOffset:0});t.service("$dragImage",["$dragImageConfig",function(t){function r(n,t,r){var u=n.measureText(t).width;if(u<r.width)return t;while(u+r.padding>r.width)t=t.substring(0,t.length-1),u=n.measureText(t+i).width;return t+i}var i="…";this.generate=function(i,u){var f=n.extend({},t,u||{}),o=document.createElement("canvas"),e,h,s;return o.height=f.height,o.width=f.width,e=o.getContext("2d"),e.fillStyle=f.backgroundColor,e.fillRect(0,0,f.width,f.height),e.font=f.font,e.fillStyle=f.fontColor,h=r(e,i,f),e.fillText(h,4,f.padding+4),s=new Image,s.src=o.toDataURL(),{image:s,xOffset:f.xOffset,yOffset:f.yOffset}}}])})(angular);