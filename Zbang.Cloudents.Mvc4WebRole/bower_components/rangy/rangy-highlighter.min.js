(function(n,t){typeof define=="function"&&define.amd?define(["./rangy-core"],n):typeof module!="undefined"&&typeof exports=="object"?module.exports=n(require("rangy")):n(t.rangy)})(function(n){return n.createModule("Highlighter",["ClassApplier"],function(n){function w(n,t){return n.characterRange.start-t.characterRange.start}function e(n,t){return t?n.getElementById(t):v(n)}function o(n,t){this.type=n;this.converterCreator=t}function s(n,t){y[n]=new o(n,t)}function h(n){var t=y[n];if(t instanceof o)return t.create();throw new Error("Highlighter type '"+n+"' is not valid");}function t(n,t){this.start=n;this.end=t}function r(n,t,i,r,u,e){u?(this.id=u,f=Math.max(f,u+1)):this.id=f++;this.characterRange=t;this.doc=n;this.classApplier=i;this.converter=r;this.containerElementId=e||null;this.applied=!1}function c(n,t){t=t||"textContent";this.doc=n||document;this.classAppliers={};this.highlights=[];this.converter=h(t)}var l=n.dom,a=l.arrayContains,v=l.getBody,u=n.util.createOptions,i=n.util.forEach,f=1,y={},p;o.prototype.create=function(){var n=this.converterCreator();return n.type=this.type,n};n.registerHighlighterType=s;t.prototype={intersects:function(n){return this.start<n.end&&this.end>n.start},isContiguousWith:function(n){return this.start==n.end||this.end==n.start},union:function(n){return new t(Math.min(this.start,n.start),Math.max(this.end,n.end))},intersection:function(n){return new t(Math.max(this.start,n.start),Math.min(this.end,n.end))},getComplements:function(n){var i=[];if(this.start>=n.start){if(this.end<=n.end)return[];i.push(new t(n.end,this.end))}else i.push(new t(this.start,Math.min(this.end,n.start))),this.end>n.end&&i.push(new t(n.end,this.end));return i},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}};t.fromCharacterRange=function(n){return new t(n.start,n.end)};p={rangeToCharacterRange:function(n,i){var r=n.getBookmark(i);return new t(r.start,r.end)},characterRangeToRange:function(t,i,r){var u=n.createRange(t);return u.moveToBookmark({start:i.start,end:i.end,containerNode:r}),u},serializeSelection:function(n,t){for(var r=n.getAllRanges(),f=r.length,u=[],e=f==1&&n.isBackward(),i=0,o=r.length;i<o;++i)u[i]={characterRange:this.rangeToCharacterRange(r[i],t),backward:e};return u},restoreSelection:function(n,t,i){var f,r,e,o,u,s;for(n.removeAllRanges(),f=n.win.document,r=0,e=t.length;r<e;++r)u=t[r],s=u.characterRange,o=this.characterRangeToRange(f,u.characterRange,i),n.addRange(o,u.backward)}};s("textContent",function(){return p});s("TextRange",function(){var i;return function(){if(!i){var r=n.modules.TextRange;if(r){if(!r.supported)throw new Error("TextRange module is present but not supported.");}else throw new Error("TextRange module is missing.");i={rangeToCharacterRange:function(n,i){return t.fromCharacterRange(n.toCharacterRange(i))},characterRangeToRange:function(t,i,r){var u=n.createRange(t);return u.selectCharacters(r,i.start,i.end),u},serializeSelection:function(n,t){return n.saveCharacterRanges(t)},restoreSelection:function(n,t,i){n.restoreCharacterRanges(i,t)}}}return i}}());r.prototype={getContainerElement:function(){return e(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(n){this.characterRange=this.converter.rangeToCharacterRange(n,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(n){return this.getRange().containsNodeContents(n.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange());this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange());this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}};c.prototype={addClassApplier:function(n){this.classAppliers[n.className]=n},getHighlightForElement:function(n){for(var i=this.highlights,t=0,r=i.length;t<r;++t)if(i[t].containsElement(n))return i[t];return null},removeHighlights:function(n){for(var t=0,r=this.highlights.length,i;t<r;++t)i=this.highlights[t],a(n,i)&&(i.unapply(),this.highlights.splice(t--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(n){var t=[],r=this.highlights;return i(n,function(n){i(r,function(i){n.intersectsRange(i.getRange())&&!a(t,i)&&t.push(i)})}),t},highlightCharacterRanges:function(f,e,o){var y,ut,h,c=this.highlights,b=this.converter,k=this.doc,ft=[],p=f?this.classAppliers[f]:null,l,et,d,g,nt,s,a,tt,w,v,it,rt;for(o=u(o,{containerElementId:null,exclusive:!0}),l=o.containerElementId,et=o.exclusive,l&&(d=this.doc.getElementById(l),d&&(g=n.createRange(this.doc),g.selectNodeContents(d),nt=new t(0,g.toString().length))),y=0,ut=e.length;y<ut;++y)if(s=e[y],v=[],nt&&(s=s.intersection(nt)),s.start!=s.end){for(h=0;h<c.length;++h)tt=!1,l==c[h].containerElementId&&(a=c[h].characterRange,w=p==c[h].classApplier,it=!w&&et,(a.intersects(s)||a.isContiguousWith(s))&&(w||it)&&(it&&i(a.getComplements(s),function(n){v.push(new r(k,n,c[h].classApplier,b,null,l))}),tt=!0,w&&(s=a.union(s)))),tt?(ft.push(c[h]),c[h]=new r(k,a.union(s),p,b,null,l)):v.push(c[h]);p&&v.push(new r(k,s,p,b,null,l));this.highlights=c=v}return i(ft,function(n){n.unapply()}),rt=[],i(c,function(n){n.applied||(n.apply(),rt.push(n))}),rt},highlightRanges:function(t,r,f){var s=[],c=this.converter,e,h,o;return f=u(f,{containerElement:null,exclusive:!0}),e=f.containerElement,h=e?e.id:null,e&&(o=n.createRange(e),o.selectNodeContents(e)),i(r,function(n){var t=e?o.intersection(n):n;s.push(c.rangeToCharacterRange(t,e||v(n.getDocument())))}),this.highlightCharacterRanges(t,s,{containerElementId:h,exclusive:f.exclusive})},highlightSelection:function(r,f){var c=this.converter,y=r?this.classAppliers[r]:!1,s,h,v;f=u(f,{containerElementId:null,selection:n.getSelection(this.doc),exclusive:!0});var l=f.containerElementId,p=f.exclusive,o=f.selection,w=o.win.document,a=e(w,l);if(!y&&r!==!1)throw new Error("No class applier found for class '"+r+"'");return s=c.serializeSelection(o,a),h=[],i(s,function(n){h.push(t.fromCharacterRange(n.characterRange))}),v=this.highlightCharacterRanges(r,h,{containerElementId:l,exclusive:p}),c.restoreSelection(o,s,a),v},unhighlightSelection:function(t){t=t||n.getSelection(this.doc);var i=this.getIntersectingHighlights(t.getAllRanges());return this.removeHighlights(i),t.removeAllRanges(),i},getHighlightsInSelection:function(t){return t=t||n.getSelection(this.doc),this.getIntersectingHighlights(t.getAllRanges())},selectionOverlapsHighlight:function(n){return this.getHighlightsInSelection(n).length>0},serialize:function(n){var t=this,o=t.highlights,r,f,e,s;return o.sort(w),n=u(n,{serializeHighlightText:!1,type:t.converter.type}),r=n.type,e=r!=t.converter.type,e&&(s=h(r)),f=["type:"+r],i(o,function(i){var r=i.characterRange,u,o;e&&(u=i.getContainerElement(),r=s.rangeToCharacterRange(t.converter.characterRangeToRange(t.doc,r,u),u));o=[r.start,r.end,i.id,i.classApplier.className,i.containerElementId];n.serializeHighlightText&&o.push(i.getText());f.push(o.join("$"))}),f.join("|")},deserialize:function(n){var u=n.split("|"),y=[],p=u[0],w,o,b,k=!1,s,c,f,l,a,v,i;if(p&&(w=/^type:(\w+)$/.exec(p)))o=w[1],o!=this.converter.type&&(b=h(o),k=!0),u.shift();else throw new Error("Serialized highlights are invalid.");for(v=u.length;v-->0;){if(i=u[v].split("$"),f=new t(+i[0],+i[1]),l=i[4]||null,k&&(a=e(this.doc,l),f=this.converter.rangeToCharacterRange(b.characterRangeToRange(this.doc,f,a),a)),s=this.classAppliers[i[3]],!s)throw new Error("No class applier found for class '"+i[3]+"'");c=new r(this.doc,f,s,this.converter,parseInt(i[2]),l);c.apply();y.push(c)}this.highlights=y}};n.Highlighter=c;n.createHighlighter=function(n,t){return new c(n,t)}}),n},this);