(function(n,t){typeof define=="function"&&define.amd?define(n):typeof module!="undefined"&&typeof exports=="object"?module.exports=n():t.rangy=n()})(function(){function t(n,t){var i=typeof n[t];return i==ht||!!(i==g&&n[t])||i=="unknown"}function y(n,t){return!!(typeof n[t]==g&&n[t])}function nt(n,t){return typeof n[t]!=f}function p(n){return function(t,i){for(var r=i.length;r--;)if(!n(t,i[r]))return!1;return!0}}function tt(n){return n&&w(n,vt)&&b(n,at)}function it(n){return y(n,"body")?n.body:n.getElementsByTagName("body")[0]}function o(n){typeof console!=f&&t(console,"log")&&console.log(n)}function rt(n,t){i&&t?alert(n):o(n)}function u(t){n.initialized=!0;n.supported=!1;rt("Rangy is not supported in this environment. Reason: "+t,n.config.alertOnFail)}function wt(t){rt("Rangy warning: "+t,n.config.alertOnWarn)}function ut(n){return n.message||n.description||String(n)}function k(){var f,s,h,r,v,y,p,l,k;if(i&&!n.initialized){if(s=!1,h=!1,t(document,"createRange")&&(f=document.createRange(),w(f,lt)&&b(f,ct)&&(s=!0)),r=it(document),!r||r.nodeName.toLowerCase()!="body"){u("No body element found");return}if(r&&t(r,"createTextRange")&&(f=r.createTextRange(),tt(f)&&(h=!0)),!s&&!h){u("Neither Range nor TextRange are available");return}n.initialized=!0;n.features={implementsDomRange:s,implementsTextRange:h};for(p in e)(v=e[p])instanceof a&&v.init(v,n);for(l=0,k=c.length;l<k;++l)try{c[l](n)}catch(d){y="Rangy init listener threw an exception. Continuing. Detail: "+ut(d);o(y)}}}function ft(t,i,r){r&&(t+=" in module "+r.name);n.warn("DEPRECATED: "+t+" is deprecated. Please use "+i+" instead.")}function et(n,t,i,u){n[t]=function(){return ft(t,i,u),n[i].apply(n,r.toArray(arguments))}}function bt(n){n=n||window;k();for(var t=0,i=l.length;t<i;++t)l[t](n)}function a(n,t,i){this.name=n;this.dependencies=t;this.initialized=!1;this.supported=!1;this.initializer=i}function ot(t,i,r){var u=new a(t,i,function(i){if(!i.initialized){i.initialized=!0;try{r(n,i);i.supported=!0}catch(u){var f="Module '"+t+"' failed to load: "+ut(u);o(f);u.stack&&o(u.stack)}}});return e[t]=u,u}function st(){}function kt(){}var g="object",ht="function",f="undefined",ct=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],lt=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],at=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],vt=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],w=p(t),yt=p(y),b=p(nt),pt=[].forEach?function(n,t){n.forEach(t)}:function(n,t){for(var i=0,r=n.length;i<r;++i)t(n[i],i)},e={},i=typeof window!=f&&typeof document!=f,r={isHostMethod:t,isHostObject:y,isHostProperty:nt,areHostMethods:w,areHostObjects:yt,areHostProperties:b,isTextRange:tt,getBody:it,forEach:pt},n={version:"1.3.0",initialized:!1,isBrowser:i,supported:!0,util:r,features:{},modules:e,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==f?!0:rangyAutoInitialize}},s,h,c,l,d,v;return n.fail=u,n.warn=wt,{}.hasOwnProperty?(r.extend=s=function(n,t,i){var u,r;for(var f in t)t.hasOwnProperty(f)&&(u=n[f],r=t[f],i&&u!==null&&typeof u=="object"&&r!==null&&typeof r=="object"&&s(u,r,!0),n[f]=r);return t.hasOwnProperty("toString")&&(n.toString=t.toString),n},r.createOptions=function(n,t){var i={};return s(i,t),n&&s(i,n),i}):u("hasOwnProperty not supported"),i||u("Rangy can only run in a browser"),function(){var n,t,u;if(i){t=document.createElement("div");t.appendChild(document.createElement("span"));u=[].slice;try{u.call(t.childNodes,0)[0].nodeType==1&&(n=function(n){return u.call(n,0)})}catch(f){}}n||(n=function(n){for(var i=[],t=0,r=n.length;t<r;++t)i[t]=n[t];return i});r.toArray=n}(),i&&(t(document,"addEventListener")?h=function(n,t,i){n.addEventListener(t,i,!1)}:t(document,"attachEvent")?h=function(n,t,i){n.attachEvent("on"+t,i)}:u("Document does not have required addEventListener or attachEvent method"),r.addListener=h),c=[],r.deprecationNotice=ft,r.createAliasForDeprecatedMethod=et,n.init=k,n.addInitListener=function(t){n.initialized?t(n):c.push(t)},l=[],n.addShimListener=function(n){l.push(n)},i&&(n.shim=n.createMissingNativeApi=bt,et(n,"createMissingNativeApi","shim")),a.prototype={init:function(){for(var r=this.dependencies||[],i=0,u=r.length,n,t;i<u;++i){if(t=r[i],n=e[t],!n||!(n instanceof a))throw new Error("required module '"+t+"' not found");if(n.init(),!n.supported)throw new Error("required module '"+t+"' not supported");}this.initializer(this)},fail:function(n){this.initialized=!0;this.supported=!1;throw new Error(n);},warn:function(t){n.warn("Module "+this.name+": "+t)},deprecationNotice:function(t,i){n.warn("DEPRECATED: "+t+" in module "+this.name+" is deprecated. Please use "+i+" instead")},createError:function(n){return new Error("Error in Rangy "+this.name+" module: "+n)}},n.createModule=function(t){var i,r,u;arguments.length==2?(i=arguments[1],r=[]):(i=arguments[2],r=arguments[1]);u=ot(t,r,i);n.initialized&&n.supported&&u.init()},n.createCoreModule=function(n,t,i){ot(n,t,i)},n.RangePrototype=st,n.rangePrototype=new st,n.selectionPrototype=new kt,n.createCoreModule("DomUtil",[],function(n,t){function ut(n){var t;return typeof n.namespaceURI==r||(t=n.namespaceURI)===null||t=="http://www.w3.org/1999/xhtml"}function ft(n){var t=n.parentNode;return t.nodeType==1?t:null}function f(n){for(var t=0;n=n.previousSibling;)++t;return t}function et(n){switch(n.nodeType){case 7:case 10:return 0;case 3:case 8:return n.length;default:return n.childNodes.length}}function p(n,t){for(var r=[],i=n;i;i=i.parentNode)r.push(i);for(i=t;i;i=i.parentNode)if(c(r,i))return i;return null}function w(n,t,i){for(var r=i?t:t.parentNode;r;){if(r===n)return!0;r=r.parentNode}return!1}function ot(n,t){return w(n,t,!0)}function e(n,t,i){for(var u,r=i?n:n.parentNode;r;){if(u=r.parentNode,u===t)return r;r=u}return null}function b(n){var t=n.nodeType;return t==3||t==4||t==8}function st(n){if(!n)return!1;var t=n.nodeType;return t==3||t==8}function k(n,t){var i=t.nextSibling,r=t.parentNode;return i?r.insertBefore(n,i):r.appendChild(n),n}function ht(n,t,i){var u=n.cloneNode(!1),e,r;if(u.deleteData(0,t),n.deleteData(t,n.length-t),k(u,n),i)for(e=0;r=i[e++];)r.node==n&&r.offset>t?(r.node=u,r.offset-=t):r.node==n.parentNode&&r.offset>f(n)&&++r.offset;return u}function o(n){if(n.nodeType==9)return n;if(typeof n.ownerDocument!=r)return n.ownerDocument;if(typeof n.document!=r)return n.document;if(n.parentNode)return o(n.parentNode);throw t.createError("getDocument: no document found for node");}function d(n){var i=o(n);if(typeof i.defaultView!=r)return i.defaultView;if(typeof i.parentWindow!=r)return i.parentWindow;throw t.createError("Cannot get a window object for node");}function g(n){if(typeof n.contentDocument!=r)return n.contentDocument;if(typeof n.contentWindow!=r)return n.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element");}function ct(n){if(typeof n.contentWindow!=r)return n.contentWindow;if(typeof n.contentDocument!=r)return n.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element");}function nt(n){return n&&i.isHostMethod(n,"setTimeout")&&i.isHostObject(n,"document")}function lt(n,t,r){var u;if(n?i.isHostProperty(n,"nodeType")?u=n.nodeType==1&&n.tagName.toLowerCase()=="iframe"?g(n):o(n):nt(n)&&(u=n.document):u=document,!u)throw t.createError(r+"(): Parameter must be a Window object or DOM node");return u}function at(n){for(var t;t=n.parentNode;)n=t;return n}function vt(n,i,r,u){var h,o,c,l,s;if(n==r)return i===u?0:i<u?-1:1;if(h=e(r,n,!0))return i<=f(h)?-1:1;if(h=e(n,r,!0))return f(h)<u?-1:1;if(o=p(n,r),!o)throw new Error("comparePoints error: nodes have no common ancestor");if(c=n===o?o:e(n,o,!0),l=r===o?o:e(r,o,!0),c===l)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");else for(s=o.firstChild;s;){if(s===c)return-1;if(s===l)return 1;s=s.nextSibling}}function l(n){var t;try{return t=n.parentNode,!1}catch(i){return!0}}function tt(n){if(!n)return"[No node]";if(s&&l(n))return"[Broken node]";if(b(n))return'"'+n.data+'"';if(n.nodeType==1){var t=n.id?' id="'+n.id+'"':"";return"<"+n.nodeName+t+">[index:"+f(n)+",length:"+n.childNodes.length+"]["+(n.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return n.nodeName}function yt(n){for(var t=o(n).createDocumentFragment(),i;i=n.firstChild;)t.appendChild(i);return t}function pt(n,t,i){var u=y(n),r=n.createElement("div"),f;return r.contentEditable=""+!!i,t&&(r.innerHTML=t),f=u.firstChild,f?u.insertBefore(r,f):u.appendChild(r),r}function wt(n){return n.parentNode.removeChild(n)}function it(n){this.root=n;this._next=n}function bt(n){return new it(n)}function rt(n,t){this.node=n;this.offset=t}function v(n){this.code=this[n];this.codeName=n;this.message="DOMException: "+this.codeName}var r="undefined",i=n.util,y=i.getBody,u,h,c,s,a;i.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method");i.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");u=document.createElement("div");i.areHostMethods(u,["insertBefore","appendChild","cloneNode"]||!i.areHostObjects(u,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation");i.isHostProperty(u,"innerHTML")||t.fail("Element is missing innerHTML property");h=document.createTextNode("test");i.areHostMethods(h,["splitText","deleteData","insertData","appendData","cloneNode"]||!i.areHostObjects(u,["previousSibling","nextSibling","childNodes","parentNode"])||!i.areHostProperties(h,["data"]))||t.fail("Incomplete Text Node implementation");c=function(n,t){for(var i=n.length;i--;)if(n[i]===t)return!0;return!1};s=!1,function(){var t=document.createElement("b"),i;t.innerHTML="1";i=t.firstChild;t.innerHTML="<br />";s=l(i);n.features.crashyTextNodes=s}();typeof getComputedStyle!=r?a=function(n,t){return d(n).getComputedStyle(n,null)[t]}:typeof document.documentElement.currentStyle!=r?a=function(n,t){return n.currentStyle?n.currentStyle[t]:""}:t.fail("No means of obtaining computed style properties found");it.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var n=this._current=this._next,t,i;if(this._current)if(t=n.firstChild,t)this._next=t;else{for(i=null;n!==this.root&&!(i=n.nextSibling);)n=n.parentNode;this._next=i}return this._current},detach:function(){this._current=this._next=this.root=null}};rt.prototype={equals:function(n){return!!n&&this.node===n.node&&this.offset==n.offset},inspect:function(){return"[DomPosition("+tt(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}};v.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24};v.prototype.toString=function(){return this.message};n.dom={arrayContains:c,isHtmlNamespace:ut,parentElement:ft,getNodeIndex:f,getNodeLength:et,getCommonAncestor:p,isAncestorOf:w,isOrIsAncestorOf:ot,getClosestAncestorIn:e,isCharacterDataNode:b,isTextOrCommentNode:st,insertAfter:k,splitDataNode:ht,getDocument:o,getWindow:d,getIframeWindow:ct,getIframeDocument:g,getBody:y,isWindow:nt,getContentDocument:lt,getRootContainer:at,comparePoints:vt,isBrokenNode:l,inspectNode:tt,getComputedStyleProperty:a,createTestElement:pt,removeNode:wt,fragmentFromNodeChildren:yt,createIterator:bt,DomPosition:rt};n.DOMException=v}),n.createCoreModule("DomRange",["DomUtil"],function(n){function y(n,t){return n.nodeType!=3&&(a(n,t.startContainer)||a(n,t.endContainer))}function e(n){return n.document||g(n.startContainer)}function di(n){return o(n.startContainer)}function vt(n){return new lt(n.parentNode,h(n))}function rt(n){return new lt(n.parentNode,h(n)+1)}function yt(n,r,u){var f=n.nodeType==11?n.firstChild:n;return i(r)?u==r.length?t.insertAfter(n,r):r.parentNode.insertBefore(n,u==0?r:nt(r,u)):u>=r.childNodes.length?r.appendChild(n):r.insertBefore(n,r.childNodes[u]),f}function pt(n,t,i){if(r(n),r(t),e(t)!=e(n))throw new f("WRONG_DOCUMENT_ERR");var o=u(n.startContainer,n.startOffset,t.endContainer,t.endOffset),s=u(n.endContainer,n.endOffset,t.startContainer,t.startOffset);return i?o<=0&&s>=0:o<0&&s>0}function wt(n){for(var i,t,u=e(n.range).createDocumentFragment(),r;t=n.next();){if(i=n.isPartiallySelectedSubtree(),t=t.cloneNode(!i),i&&(r=n.getSubtreeIterator(),t.appendChild(wt(r)),r.detach()),t.nodeType==10)throw new f("HIERARCHY_REQUEST_ERR");u.appendChild(t)}return u}function b(n,i,r){var e,o,u,f;for(r=r||{stop:!1};u=n.next();)if(n.isPartiallySelectedSubtree()){if(i(u)===!1){r.stop=!0;return}if(f=n.getSubtreeIterator(),b(f,i,r),f.detach(),r.stop)return}else for(e=t.createIterator(u);o=e.next();)if(i(o)===!1){r.stop=!0;return}}function bt(n){for(var t;n.next();)n.isPartiallySelectedSubtree()?(t=n.getSubtreeIterator(),bt(t),t.detach()):n.remove()}function kt(n){for(var t,r=e(n.range).createDocumentFragment(),i;t=n.next();){if(n.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),i=n.getSubtreeIterator(),t.appendChild(kt(i)),i.detach()):n.remove(),t.nodeType==10)throw new f("HIERARCHY_REQUEST_ERR");r.appendChild(t)}return r}function gi(n,t,r){var f=!!(t&&t.length),e,o=!!r,u;return f&&(e=new RegExp("^("+t.join("|")+")$")),u=[],b(new s(n,!1),function(t){var s,h;(!f||e.test(t.nodeType))&&(!o||r(t))&&((s=n.startContainer,t==s&&i(s)&&n.startOffset==s.length)||(h=n.endContainer,t==h&&i(h)&&n.endOffset==0)||u.push(t))}),u}function dt(n){var i=typeof n.getName=="undefined"?"Range":n.getName();return"["+i+"("+t.inspectNode(n.startContainer)+":"+n.startOffset+", "+t.inspectNode(n.endContainer)+":"+n.endOffset+")]"}function s(n,t){if(this.range=n,this.clonePartiallySelectedTextNodes=t,!n.collapsed){this.sc=n.startContainer;this.so=n.startOffset;this.ec=n.endContainer;this.eo=n.endOffset;var r=n.commonAncestorContainer;this.sc===this.ec&&i(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===r&&!i(this.sc)?this.sc.childNodes[this.so]:tt(this.sc,r,!0),this._last=this.ec===r&&!i(this.ec)?this.ec.childNodes[this.eo-1]:tt(this.ec,r,!0))}}function ut(n){return function(t,i){for(var u,r=i?t:t.parentNode;r;){if(u=r.nodeType,at(n,u))return r;r=r.parentNode}return null}}function p(n,t){if(ur(n,t))throw new f("INVALID_NODE_TYPE_ERR");}function w(n,t){if(!at(t,n.nodeType))throw new f("INVALID_NODE_TYPE_ERR");}function ft(n,t){if(t<0||t>(i(n)?n.length:n.childNodes.length))throw new f("INDEX_SIZE_ERR");}function et(n,t){if(ni(n,!0)!==ni(t,!0))throw new f("WRONG_DOCUMENT_ERR");}function c(n){if(rr(n,!0))throw new f("NO_MODIFICATION_ALLOWED_ERR");}function ti(n,t){if(!n)throw new f(t);}function ii(n,t){return t<=(i(n)?n.length:n.childNodes.length)}function ri(n){return!!n.startContainer&&!!n.endContainer&&!(ki&&(t.isBrokenNode(n.startContainer)||t.isBrokenNode(n.endContainer)))&&o(n.startContainer)==o(n.endContainer)&&ii(n.startContainer,n.startOffset)&&ii(n.endContainer,n.endOffset)}function r(n){if(!ri(n))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+n.inspect()+")");}function fi(n,t){r(n);var u=n.startContainer,o=n.startOffset,f=n.endContainer,e=n.endOffset,s=u===f;i(f)&&e>0&&e<f.length&&nt(f,e,t);i(u)&&o>0&&o<u.length&&(u=nt(u,o,t),s?(e-=o,f=u):f==u.parentNode&&e>=h(u)&&e++,o=0);n.setStartAndEnd(u,o,f,e)}function ei(n){r(n);var t=n.commonAncestorContainer.parentNode.cloneNode(!1);return t.appendChild(n.cloneContents()),t.innerHTML}function ai(n){n.START_TO_START=ht;n.START_TO_END=oi;n.END_TO_END=fr;n.END_TO_START=si;n.NODE_BEFORE=hi;n.NODE_AFTER=ci;n.NODE_BEFORE_AND_AFTER=li;n.NODE_INSIDE=ct}function vi(n){ai(n);ai(n.prototype)}function yi(n,t){return function(){var l;r(this);var i=this.startContainer,f=this.startOffset,o=this.commonAncestorContainer,u=new s(this,!0),h,e;return i!==o&&(h=tt(i,o,!0),e=rt(h),i=e.node,f=e.offset),b(u,c),u.reset(),l=n(u),u.detach(),t(this,i,f,i,f),l}}function pi(t,f){function e(n,t){return function(i){w(i,gt);w(o(i),nr);var r=(n?vt:rt)(i);(t?l:a)(this,r.node,r.offset)}}function l(n,t,i){var r=n.endContainer,e=n.endOffset;(t!==n.startContainer||i!==n.startOffset)&&((o(t)!=o(r)||u(t,i,r,e)==1)&&(r=t,e=i),f(n,t,i,r,e))}function a(n,t,i){var r=n.startContainer,e=n.startOffset;(t!==n.endContainer||i!==n.endOffset)&&((o(t)!=o(r)||u(t,i,r,e)==-1)&&(r=t,e=i),f(n,r,e,t,i))}var b=function(){};b.prototype=n.rangePrototype;t.prototype=new b;d.extend(t.prototype,{setStart:function(n,t){p(n,!0);ft(n,t);l(this,n,t)},setEnd:function(n,t){p(n,!0);ft(n,t);a(this,n,t)},setStartAndEnd:function(){var n=arguments,i=n[0],r=n[1],u=i,t=r;switch(n.length){case 3:t=n[2];break;case 4:u=n[2];t=n[3]}f(this,i,r,u,t)},setBoundary:function(n,t,i){this["set"+(i?"Start":"End")](n,t)},setStartBefore:e(!0,!0),setStartAfter:e(!1,!0),setEndBefore:e(!0,!1),setEndAfter:e(!1,!1),collapse:function(n){r(this);n?f(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):f(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(n){p(n,!0);f(this,n,0,n,it(n))},selectNode:function(n){p(n,!1);w(n,gt);var t=vt(n),i=rt(n);f(this,t.node,t.offset,i.node,i.offset)},extractContents:yi(kt,f),deleteContents:yi(bt,f),canSurroundContents:function(){r(this);c(this.startContainer);c(this.endContainer);var n=new s(this,!0),t=n._first&&y(n._first,this)||n._last&&y(n._last,this);return n.detach(),!t},splitBoundaries:function(){fi(this)},splitBoundariesPreservingPositions:function(n){fi(this,n)},normalizeBoundaries:function(){var s,c;r(this);var t=this.startContainer,o=this.startOffset,n=this.endContainer,u=this.endOffset,a=function(t){var i=t.nextSibling;i&&i.nodeType==t.nodeType&&(n=t,u=t.length,t.appendData(i.data),v(i))},y=function(i){var r=i.previousSibling,e,f;r&&r.nodeType==i.nodeType&&(t=i,e=i.length,o=r.length,i.insertData(0,r.data),v(r),t==n?(u+=o,n=t):n==i.parentNode&&(f=h(i),u==f?(n=i,u=e):u>f&&u--))},l=!0,e;i(n)?u==n.length?a(n):u==0&&(e=n.previousSibling,e&&e.nodeType==n.nodeType&&(u=e.length,t==n&&(l=!1),e.appendData(n.data),v(n),n=e)):(u>0&&(s=n.childNodes[u-1],s&&i(s)&&a(s)),l=!this.collapsed);l?i(t)?o==0?y(t):o==t.length&&(e=t.nextSibling,e&&e.nodeType==t.nodeType&&(n==e&&(n=t,u+=t.length),t.appendData(e.data),v(e))):o<t.childNodes.length&&(c=t.childNodes[o],c&&i(c)&&y(c)):(t=n,o=u);f(this,t,o,n,u)},collapseToPoint:function(n,t){p(n,!0);ft(n,t);this.setStartAndEnd(n,t)}});vi(t)}function wi(n){n.collapsed=n.startContainer===n.endContainer&&n.startOffset===n.endOffset;n.commonAncestorContainer=n.collapsed?n.startContainer:t.getCommonAncestor(n.startContainer,n.endContainer)}function bi(n,i,r,u,f){n.startContainer=i;n.startOffset=r;n.endContainer=u;n.endOffset=f;n.document=t.getDocument(i);wi(n)}function l(n){this.startContainer=n;this.startOffset=0;this.endContainer=n;this.endOffset=0;this.document=n;wi(this)}var t=n.dom,d=n.util,lt=t.DomPosition,f=n.DOMException,i=t.isCharacterDataNode,h=t.getNodeIndex,a=t.isOrIsAncestorOf,g=t.getDocument,u=t.comparePoints,nt=t.splitDataNode,tt=t.getClosestAncestorIn,it=t.getNodeLength,at=t.arrayContains,o=t.getRootContainer,ki=n.features.crashyTextNodes,v=t.removeNode,ot,k,ui;s.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var n=this._current=this._next;return n&&(this._next=n!==this._last?n.nextSibling:null,i(n)&&this.clonePartiallySelectedTextNodes&&(n===this.ec&&(n=n.cloneNode(!0)).deleteData(this.eo,n.length-this.eo),this._current===this.sc&&(n=n.cloneNode(!0)).deleteData(0,this.so))),n},remove:function(){var n=this._current,t,r;i(n)&&(n===this.sc||n===this.ec)?(t=n===this.sc?this.so:0,r=n===this.ec?this.eo:n.length,t!=r&&n.deleteData(t,r-t)):n.parentNode&&v(n)},isPartiallySelectedSubtree:function(){var n=this._current;return y(n,this.range)},getSubtreeIterator:function(){var n;if(this.isSingleCharacterDataNode)n=this.range.cloneRange(),n.collapse(!1);else{n=new l(e(this.range));var t=this._current,i=t,r=0,u=t,f=it(t);a(t,this.sc)&&(i=this.sc,r=this.so);a(t,this.ec)&&(u=this.ec,f=this.eo);bi(n,i,r,u,f)}return new s(n,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var gt=[1,3,4,5,7,8,10],nr=[2,9,11],tr=[1,3,4,5,7,8,10,11],ir=[1,3,4,5,7,8];var ni=ut([9,11]),rr=ut([5,6,10,12]),ur=ut([6,10,12]);ot=document.createElement("style");k=!1;try{ot.innerHTML="<b>x<\/b>";k=ot.firstChild.nodeType==3}catch(er){}n.features.htmlParsingConforms=k;ui=k?function(n){var u=this.startContainer,e=g(u),r;if(!u)throw new f("INVALID_STATE_ERR");return r=null,u.nodeType==1?r=u:i(u)&&(r=t.parentElement(u)),r=r===null||r.nodeName=="HTML"&&t.isHtmlNamespace(g(r).documentElement)&&t.isHtmlNamespace(r)?e.createElement("body"):r.cloneNode(!1),r.innerHTML=n,t.fragmentFromNodeChildren(r)}:function(n){var r=e(this),i=r.createElement("body");return i.innerHTML=n,t.fragmentFromNodeChildren(i)};var st=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],ht=0,oi=1,fr=2,si=3,hi=0,ci=1,li=2,ct=3;d.extend(n.rangePrototype,{compareBoundaryPoints:function(n,t){r(this);et(this.startContainer,t.startContainer);var i,f,e,o,s=n==si||n==ht?"start":"end",h=n==oi||n==ht?"start":"end";return i=this[s+"Container"],f=this[s+"Offset"],e=t[h+"Container"],o=t[h+"Offset"],u(i,f,e,o)},insertNode:function(n){if(r(this),w(n,tr),c(this.startContainer),a(n,this.startContainer))throw new f("HIERARCHY_REQUEST_ERR");var t=yt(n,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){var n,t,u;return r(this),this.collapsed?e(this).createDocumentFragment():this.startContainer===this.endContainer&&i(this.startContainer)?(n=this.startContainer.cloneNode(!0),n.data=n.data.slice(this.startOffset,this.endOffset),t=e(this).createDocumentFragment(),t.appendChild(n),t):(u=new s(this,!0),n=wt(u),u.detach(),n)},canSurroundContents:function(){r(this);c(this.startContainer);c(this.endContainer);var n=new s(this,!0),t=n._first&&y(n._first,this)||n._last&&y(n._last,this);return n.detach(),!t},surroundContents:function(n){if(w(n,ir),!this.canSurroundContents())throw new f("INVALID_STATE_ERR");var t=this.extractContents();if(n.hasChildNodes())while(n.lastChild)n.removeChild(n.lastChild);yt(n,this.startContainer,this.startOffset);n.appendChild(t);this.selectNode(n)},cloneRange:function(){r(this);for(var t=new l(e(this)),i=st.length,n;i--;)n=st[i],t[n]=this[n];return t},toString:function(){var n,t,u;return r(this),n=this.startContainer,n===this.endContainer&&i(n)?n.nodeType==3||n.nodeType==4?n.data.slice(this.startOffset,this.endOffset):"":(t=[],u=new s(this,!0),b(u,function(n){(n.nodeType==3||n.nodeType==4)&&t.push(n.data)}),u.detach(),t.join(""))},compareNode:function(n){var t,i,e,u;if(r(this),t=n.parentNode,i=h(n),!t)throw new f("NOT_FOUND_ERR");return e=this.comparePoint(t,i),u=this.comparePoint(t,i+1),e<0?u>0?li:hi:u>0?ci:ct},comparePoint:function(n,t){return(r(this),ti(n,"HIERARCHY_REQUEST_ERR"),et(n,this.startContainer),u(n,t,this.startContainer,this.startOffset)<0)?-1:u(n,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:ui,toHtml:function(){return ei(this)},intersectsNode:function(n,t){var i,f,e,s;return(r(this),o(n)!=di(this))?!1:(i=n.parentNode,f=h(n),!i)?!0:(e=u(i,f,this.endContainer,this.endOffset),s=u(i,f+1,this.startContainer,this.startOffset),t?e<=0&&s>=0:e<0&&s>0)},isPointInRange:function(n,t){return r(this),ti(n,"HIERARCHY_REQUEST_ERR"),et(n,this.startContainer),u(n,t,this.startContainer,this.startOffset)>=0&&u(n,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(n){return pt(this,n,!1)},intersectsOrTouchesRange:function(n){return pt(this,n,!0)},intersection:function(n){if(this.intersectsRange(n)){var i=u(this.startContainer,this.startOffset,n.startContainer,n.startOffset),r=u(this.endContainer,this.endOffset,n.endContainer,n.endOffset),t=this.cloneRange();return i==-1&&t.setStart(n.startContainer,n.startOffset),r==1&&t.setEnd(n.endContainer,n.endOffset),t}return null},union:function(n){if(this.intersectsOrTouchesRange(n)){var t=this.cloneRange();return u(n.startContainer,n.startOffset,this.startContainer,this.startOffset)==-1&&t.setStart(n.startContainer,n.startOffset),u(n.endContainer,n.endOffset,this.endContainer,this.endOffset)==1&&t.setEnd(n.endContainer,n.endOffset),t}throw new f("Ranges do not intersect");},containsNode:function(n,t){return t?this.intersectsNode(n,!1):this.compareNode(n)==ct},containsNodeContents:function(n){return this.comparePoint(n,0)>=0&&this.comparePoint(n,it(n))<=0},containsRange:function(n){var t=this.intersection(n);return t!==null&&n.equals(t)},containsNodeText:function(n){var t=this.cloneRange(),i,r;return t.selectNode(n),i=t.getNodes([3]),i.length>0?(t.setStart(i[0],0),r=i.pop(),t.setEnd(r,r.length),this.containsRange(t)):this.containsNodeContents(n)},getNodes:function(n,t){return r(this),gi(this,n,t)},getDocument:function(){return e(this)},collapseBefore:function(n){this.setEndBefore(n);this.collapse(!1)},collapseAfter:function(n){this.setStartAfter(n);this.collapse(!0)},getBookmark:function(i){var o=e(this),r=n.createRange(o);i=i||t.getBody(o);r.selectNodeContents(i);var u=this.intersection(r),f=0,s=0;return u&&(r.setEnd(u.startContainer,u.startOffset),f=r.toString().length,s=f+u.toString().length),{start:f,end:s,containerNode:i}},moveToBookmark:function(n){var o=n.containerNode,t=0;this.setStart(o,0);this.collapse(!0);for(var s=[o],i,u=!1,h=!1,r,f,e;!h&&(i=s.pop());)if(i.nodeType==3)r=t+i.length,!u&&n.start>=t&&n.start<=r&&(this.setStart(i,n.start-t),u=!0),u&&n.end>=t&&n.end<=r&&(this.setEnd(i,n.end-t),h=!0),t=r;else for(e=i.childNodes,f=e.length;f--;)s.push(e[f])},getName:function(){return"DomRange"},equals:function(n){return l.rangesEqual(this,n)},isValid:function(){return ri(this)},inspect:function(){return dt(this)},detach:function(){}});pi(l,bi);d.extend(l,{rangeProperties:st,RangeIterator:s,copyComparisonConstants:vi,createPrototypeRange:pi,inspect:dt,toHtml:ei,getRangeDocument:e,rangesEqual:function(n,t){return n.startContainer===t.startContainer&&n.startOffset===t.startOffset&&n.endContainer===t.endContainer&&n.endOffset===t.endOffset}});n.DomRange=l}),n.createCoreModule("WrappedRange",["DomRange"],function(n,t){var o,r,i=n.dom,c=n.util,u=i.DomPosition,f=n.DomRange,e=i.getBody,s=i.getContentDocument,h=i.isCharacterDataNode,v,y;if(n.features.implementsDomRange&&function(){function h(n){for(var i=b.length,t;i--;)t=b[i],n[t]=n.nativeRange[t];n.collapsed=n.startContainer===n.endContainer&&n.startOffset===n.endOffset}function k(n,t,i,r,u){var f=n.startContainer!==t||n.startOffset!=i,e=n.endContainer!==r||n.endOffset!=u,o=!n.equals(n.nativeRange);(f||e||o)&&(n.setEnd(r,u),n.setStart(t,i))}var r,b=f.rangeProperties,a,l,u,v,y,p,w;o=function(n){if(!n)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=n;h(this)};f.createPrototypeRange(o,k);r=o.prototype;r.selectNode=function(n){this.nativeRange.selectNode(n);h(this)};r.cloneContents=function(){return this.nativeRange.cloneContents()};r.surroundContents=function(n){this.nativeRange.surroundContents(n);h(this)};r.collapse=function(n){this.nativeRange.collapse(n);h(this)};r.cloneRange=function(){return new o(this.nativeRange.cloneRange())};r.refresh=function(){h(this)};r.toString=function(){return this.nativeRange.toString()};l=document.createTextNode("test");e(document).appendChild(l);u=document.createRange();u.setStart(l,0);u.setEnd(l,0);try{u.setStart(l,1);r.setStart=function(n,t){this.nativeRange.setStart(n,t);h(this)};r.setEnd=function(n,t){this.nativeRange.setEnd(n,t);h(this)};a=function(n){return function(t){this.nativeRange[n](t);h(this)}}}catch(d){r.setStart=function(n,t){try{this.nativeRange.setStart(n,t)}catch(i){this.nativeRange.setEnd(n,t);this.nativeRange.setStart(n,t)}h(this)};r.setEnd=function(n,t){try{this.nativeRange.setEnd(n,t)}catch(i){this.nativeRange.setStart(n,t);this.nativeRange.setEnd(n,t)}h(this)};a=function(n,t){return function(i){try{this.nativeRange[n](i)}catch(r){this.nativeRange[t](i);this.nativeRange[n](i)}h(this)}}}r.setStartBefore=a("setStartBefore","setEndBefore");r.setStartAfter=a("setStartAfter","setEndAfter");r.setEndBefore=a("setEndBefore","setStartBefore");r.setEndAfter=a("setEndAfter","setStartAfter");r.selectNodeContents=function(n){this.setStartAndEnd(n,0,i.getNodeLength(n))};u.selectNodeContents(l);u.setEnd(l,3);v=document.createRange();v.selectNodeContents(l);v.setEnd(l,4);v.setStart(l,2);r.compareBoundaryPoints=u.compareBoundaryPoints(u.START_TO_END,v)==-1&&u.compareBoundaryPoints(u.END_TO_START,v)==1?function(n,t){return t=t.nativeRange||t,n==t.START_TO_END?n=t.END_TO_START:n==t.END_TO_START&&(n=t.START_TO_END),this.nativeRange.compareBoundaryPoints(n,t)}:function(n,t){return this.nativeRange.compareBoundaryPoints(n,t.nativeRange||t)};y=document.createElement("div");y.innerHTML="123";p=y.firstChild;w=e(document);w.appendChild(y);u.setStart(p,1);u.setEnd(p,2);u.deleteContents();p.data=="13"&&(r.deleteContents=function(){this.nativeRange.deleteContents();h(this)},r.extractContents=function(){var n=this.nativeRange.extractContents();return h(this),n});w.removeChild(y);w=null;c.isHostMethod(u,"createContextualFragment")&&(r.createContextualFragment=function(n){return this.nativeRange.createContextualFragment(n)});e(document).removeChild(l);r.getName=function(){return"WrappedRange"};n.WrappedRange=o;n.createNativeRange=function(n){return n=s(n,t,"createNativeRange"),n.createRange()}}(),n.features.implementsTextRange){var p=function(n){var e=n.parentElement(),t=n.duplicate(),r,f,u;return t.collapse(!0),r=t.parentElement(),t=n.duplicate(),t.collapse(!1),f=t.parentElement(),u=r==f?r:i.getCommonAncestor(r,f),u==e?u:i.getCommonAncestor(e,u)},w=function(n){return n.compareEndPoints("StartToEnd",n)==0},l=function(n,t,r,f,e){var c=n.duplicate(),o,k,s,g,y,it;if(c.collapse(r),o=c.parentElement(),i.isOrIsAncestorOf(t,o)||(o=t),!o.canHaveHTML)return k=new u(o.parentNode,i.getNodeIndex(o)),{boundaryPosition:k,nodeInfo:{nodeIndex:k.offset,containerElement:k.node}};s=i.getDocument(o).createElement("span");s.parentNode&&i.removeNode(s);for(var p,rt=r?"StartToStart":"StartToEnd",w,d,nt,b,l=e&&e.containerElement==o?e.nodeIndex:0,tt=o.childNodes.length,a=tt,v=a;;){if(v==tt?o.appendChild(s):o.insertBefore(s,o.childNodes[v]),c.moveToElementText(s),p=c.compareEndPoints(rt,n),p==0||l==a)break;else if(p==-1)if(a==l+1)break;else l=v;else a=a==l+1?l:v;v=Math.floor((l+a)/2);o.removeChild(s)}if(b=s.nextSibling,p==-1&&b&&h(b)){if(c.setEndPoint(r?"EndToStart":"EndToEnd",n),/[\r\n]/.test(b.data))for(y=c.duplicate(),it=y.text.replace(/\r\n/g,"\r").length,g=y.moveStart("character",it);(p=y.compareEndPoints("StartToEnd",y))==-1;)g++,y.moveStart("character",1);else g=c.text.length;nt=new u(b,g)}else w=(f||!r)&&s.previousSibling,d=(f||r)&&s.nextSibling,nt=d&&h(d)?new u(d,0):w&&h(w)?new u(w,w.data.length):new u(o,i.getNodeIndex(s));return i.removeNode(s),{boundaryPosition:nt,nodeInfo:{nodeIndex:v,containerElement:o}}},a=function(n,t){var u,f,s=n.offset,l=i.getDocument(n.node),r,c,o=e(l).createTextRange(),a=h(n.node);return a?(u=n.node,f=u.parentNode):(c=n.node.childNodes,u=s<c.length?c[s]:null,f=n.node),r=l.createElement("span"),r.innerHTML="&#feff;",u?f.insertBefore(r,u):f.appendChild(r),o.moveToElementText(r),o.collapse(!t),f.removeChild(r),a&&o[t?"moveStart":"moveEnd"]("character",s),o};r=function(n){this.textRange=n;this.refresh()};r.prototype=new f(document);r.prototype.refresh=function(){var n,t,i,r=p(this.textRange);w(this.textRange)?t=n=l(this.textRange,r,!0,!0).boundaryPosition:(i=l(this.textRange,r,!0,!1),n=i.boundaryPosition,t=l(this.textRange,r,!1,!1,i.nodeInfo).boundaryPosition);this.setStart(n.node,n.offset);this.setEnd(t.node,t.offset)};r.prototype.getName=function(){return"WrappedTextRange"};f.copyComparisonConstants(r);v=function(n){if(n.collapsed)return a(new u(n.startContainer,n.startOffset),!0);var i=a(new u(n.startContainer,n.startOffset),!0),r=a(new u(n.endContainer,n.endOffset),!1),t=e(f.getRangeDocument(n)).createTextRange();return t.setEndPoint("StartToStart",i),t.setEndPoint("EndToEnd",r),t};r.rangeToTextRange=v;r.prototype.toTextRange=function(){return v(this)};n.WrappedTextRange=r;(!n.features.implementsDomRange||n.config.preferTextRange)&&(y=function(n){return n("return this;")()}(Function),typeof y.Range=="undefined"&&(y.Range=r),n.createNativeRange=function(n){return n=s(n,t,"createNativeRange"),e(n).createTextRange()},n.WrappedRange=r)}n.createRange=function(i){return i=s(i,t,"createRange"),new n.WrappedRange(n.createNativeRange(i))};n.createRangyRange=function(n){return n=s(n,t,"createRangyRange"),new f(n)};c.createAliasForDeprecatedMethod(n,"createIframeRange","createRange");c.createAliasForDeprecatedMethod(n,"createIframeRangyRange","createRangyRange");n.addShimListener(function(t){var i=t.document;typeof i.createRange=="undefined"&&(i.createRange=function(){return n.createRange(i)});i=t=null})}),n.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(n,t){function yt(n){return typeof n=="string"?/^backward(s)?$/i.test(n):!!n}function ft(n,i){if(n){if(f.isWindow(n))return n;if(n instanceof h)return n.win;var r=f.getContentDocument(n,t,i);return f.getWindow(r)}return window}function bi(n){return ft(n,"getWinSelection").getSelection()}function fi(n){return ft(n,"getDocSelection").document.selection}function ei(n){var t=!1;return n.anchorNode&&(t=f.comparePoints(n.anchorNode,n.anchorOffset,n.focusNode,n.focusOffset)==1),t}function nt(n,t,i){var r=i?"end":"start",u=i?"start":"end";n.anchorNode=t[r+"Container"];n.anchorOffset=t[r+"Offset"];n.focusNode=t[u+"Container"];n.focusOffset=t[u+"Offset"]}function ki(n){var t=n.nativeSelection;n.anchorNode=t.anchorNode;n.anchorOffset=t.anchorOffset;n.focusNode=t.focusNode;n.focusOffset=t.focusOffset}function v(n){n.anchorNode=n.focusNode=null;n.anchorOffset=n.focusOffset=0;n.rangeCount=0;n.isCollapsed=!0;n._ranges.length=0}function kt(t){var i;return t instanceof k?(i=n.createNativeRange(t.getDocument()),i.setEnd(t.endContainer,t.endOffset),i.setStart(t.startContainer,t.startOffset)):t instanceof at?i=t.nativeRange:r.implementsDomRange&&t instanceof f.getWindow(t.startContainer).Range&&(i=t),i}function di(n){if(!n.length||n[0].nodeType!=1)return!1;for(var t=1,i=n.length;t<i;++t)if(!f.isAncestorOf(n[0],n[t]))return!1;return!0}function dt(n){var i=n.getNodes();if(!di(i))throw t.createError("getSingleElementFromRange: range "+n.inspect()+" did not consist of a single element");return i[0]}function gt(n){return!!n&&typeof n.text!="undefined"}function ci(n,t){var i=new at(t);n._ranges=[i];nt(n,i,!1);n.rangeCount=1;n.isCollapsed=i.collapsed}function tt(t){var i,u,f,r;if(t._ranges.length=0,t.docSelection.type=="None")v(t);else if(i=t.docSelection.createRange(),gt(i))ci(t,i);else{for(t.rangeCount=i.length,f=e(i.item(0)),r=0;r<t.rangeCount;++r)u=n.createRange(f),u.selectNode(i.item(r)),t._ranges.push(u);t.isCollapsed=t.rangeCount==1&&t._ranges[0].collapsed;nt(t,t._ranges[t.rangeCount-1],!1)}}function li(n,i){for(var r=n.docSelection.createRange(),o=dt(i),s=e(r.item(0)),u=y(s).createControlRange(),f=0,h=r.length;f<h;++f)u.add(r.item(f));try{u.add(o)}catch(c){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}u.select();tt(n)}function h(n,t,i){this.nativeSelection=n;this.docSelection=t;this._ranges=[];this.win=i;this.refresh()}function ai(n){n.win=n.anchorNode=n.focusNode=n._ranges=null;n.rangeCount=n.anchorOffset=n.focusOffset=0;n.detached=!0}function ni(n,t){for(var i=b.length,r,u;i--;)if(r=b[i],u=r.selection,t=="deleteAll")ai(u);else if(r.win==n)return t=="delete"?(b.splice(i,1),!0):u;return t=="deleteAll"&&(b.length=0),null}function vi(n,i){for(var o=e(i[0].startContainer),u=y(o).createControlRange(),r=0,f,s=i.length;r<s;++r){f=dt(i[r]);try{u.add(f)}catch(h){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)");}}u.select();tt(n)}function yi(n,t){if(n.win.document!=e(t))throw new rt("WRONG_DOCUMENT_ERR");}function pi(t){return function(i,r){var u;this.rangeCount?(u=this.getRangeAt(0),u["set"+(t?"Start":"End")](i,r)):(u=n.createRange(this.win.document),u.setStartAndEnd(i,r));this.setSingleRange(u,this.isBackward())}}function wi(n){var i=[],u=new ui(n.anchorNode,n.anchorOffset),f=new ui(n.focusNode,n.focusOffset),e=typeof n.getName=="function"?n.getName():"Selection",t,r;if(typeof n.rangeCount!="undefined")for(t=0,r=n.rangeCount;t<r;++t)i[t]=k.inspect(n.getRangeAt(t));return"["+e+"(Ranges: "+i.join(", ")+")(anchor: "+u.inspect()+", focus: "+f.inspect()+"]"}var et,o,p,u,g,wt,s,hi,st,b,ht,i,ti,ct,ii,it;n.config.checkSelectionRanges=!0;var ri="boolean",lt="number",f=n.dom,c=n.util,l=c.isHostMethod,k=n.DomRange,at=n.WrappedRange,rt=n.DOMException,ui=f.DomPosition,d,ut,r=n.features,a="Control",e=f.getDocument,y=f.getBody,vt=k.rangesEqual;if(et=l(window,"getSelection"),o=c.isHostObject(document,"selection"),r.implementsWinGetSelection=et,r.implementsDocSelection=o,p=o&&(!et||n.config.preferTextRange),p)d=fi,n.isSelectionValid=function(n){var t=ft(n,"isSelectionValid").document,i=t.selection;return i.type!="None"||e(i.createRange().parentElement())==t};else if(et)d=bi,n.isSelectionValid=function(){return!0};else return t.fail("Neither document.selection or window.getSelection() detected."),!1;if(n.getNativeSelection=d,u=d(),!u)return t.fail("Native selection was null (possibly issue 138?)"),!1;var oi=n.createNativeRange(document),pt=y(document),w=c.areHostProperties(u,["anchorNode","focusNode","anchorOffset","focusOffset"]);r.selectionHasAnchorAndFocus=w;g=l(u,"extend");r.selectionHasExtend=g;wt=typeof u.rangeCount==lt;r.selectionHasRangeCount=wt;var ot=!1,si=!0,bt=g?function(t,i){var u=k.getRangeDocument(i),r=n.createRange(u);r.collapseToPoint(i.endContainer,i.endOffset);t.addRange(kt(r));t.extend(i.startContainer,i.startOffset)}:null;if(c.areHostMethods(u,["addRange","getRangeAt","removeAllRanges"])&&typeof u.rangeCount==lt&&r.implementsDomRange&&function(){var t=window.getSelection(),i,h,o;if(t){var s=t.rangeCount,l=s>1,u=[],a=ei(t);for(i=0;i<s;++i)u[i]=t.getRangeAt(i);var c=f.createTestElement(document,"",!1),e=c.appendChild(document.createTextNode("   ")),r=document.createRange();for(r.setStart(e,1),r.collapse(!0),t.removeAllRanges(),t.addRange(r),si=t.rangeCount==1,t.removeAllRanges(),l||(h=window.navigator.appVersion.match(/Chrome\/(.*?) /),h&&parseInt(h[1])>=36?ot=!1:(o=r.cloneRange(),r.setStart(e,0),o.setEnd(e,3),o.setStart(e,2),t.addRange(r),t.addRange(o),ot=t.rangeCount==2)),f.removeNode(c),t.removeAllRanges(),i=0;i<s;++i)i==0&&a?bt?bt(t,u[i]):(n.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(u[i])):t.addRange(u[i])}}(),r.selectionSupportsMultipleRanges=ot,r.collapsedNonEditableSelectionsSupported=si,s=!1,pt&&l(pt,"createControlRange")&&(hi=pt.createControlRange(),c.areHostProperties(hi,["item","add"])&&(s=!0)),r.implementsControlRange=s,ut=w?function(n){return n.anchorNode===n.focusNode&&n.anchorOffset===n.focusOffset}:function(n){return n.rangeCount?n.getRangeAt(n.rangeCount-1).collapsed:!1},l(u,"getRangeAt")?st=function(n,t){try{return n.getRangeAt(t)}catch(i){return null}}:w&&(st=function(t){var r=e(t.anchorNode),i=n.createRange(r);return i.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),i.collapsed!==this.isCollapsed&&i.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),i}),h.prototype=n.selectionPrototype,b=[],ht=function(n){if(n&&n instanceof h)return n.refresh(),n;n=ft(n,"getNativeSelection");var t=ni(n),i=d(n),r=o?fi(n):null;return t?(t.nativeSelection=i,t.docSelection=r,t.refresh()):(t=new h(i,r,n),b.push({win:n,selection:t})),t},n.getSelection=ht,c.createAliasForDeprecatedMethod(n,"getIframeSelection","getSelection"),i=h.prototype,!p&&w&&c.areHostMethods(u,["removeAllRanges","addRange"]))i.removeAllRanges=function(){this.nativeSelection.removeAllRanges();v(this)},ti=function(n,t){bt(n.nativeSelection,t);n.refresh()},i.addRange=wt?function(t,i){var u,f,r;if(s&&o&&this.docSelection.type==a)li(this,t);else if(yt(i)&&g)ti(this,t);else{ot?u=this.rangeCount:(this.removeAllRanges(),u=0);f=kt(t).cloneRange();try{this.nativeSelection.addRange(f)}catch(e){}this.rangeCount=this.nativeSelection.rangeCount;this.rangeCount==u+1?(n.config.checkSelectionRanges&&(r=st(this.nativeSelection,this.rangeCount-1),r&&!vt(r,t)&&(t=new at(r))),this._ranges[this.rangeCount-1]=t,nt(this,t,it(this.nativeSelection)),this.isCollapsed=ut(this)):this.refresh()}}:function(n,t){yt(t)&&g?ti(this,n):(this.nativeSelection.addRange(kt(n)),this.refresh())},i.setRanges=function(n){if(s&&o&&n.length>1)vi(this,n);else{this.removeAllRanges();for(var t=0,i=n.length;t<i;++t)this.addRange(n[t])}};else if(l(u,"empty")&&l(oi,"select")&&s&&p)i.removeAllRanges=function(){var n,t,i;try{this.docSelection.empty();this.docSelection.type!="None"&&(this.anchorNode?n=e(this.anchorNode):this.docSelection.type==a&&(t=this.docSelection.createRange(),t.length&&(n=e(t.item(0)))),n&&(i=y(n).createTextRange(),i.select(),this.docSelection.empty()))}catch(r){}v(this)},i.addRange=function(t){this.docSelection.type==a?li(this,t):(n.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,nt(this,t,!1))},i.setRanges=function(n){this.removeAllRanges();var t=n.length;t>1?vi(this,n):t&&this.addRange(n[0])};else return t.fail("No means of selecting a Range or TextRange was found"),!1;if(i.getRangeAt=function(n){if(n<0||n>=this.rangeCount)throw new rt("INDEX_SIZE_ERR");else return this._ranges[n].cloneRange()},p)ct=function(t){var i;n.isSelectionValid(t.win)?i=t.docSelection.createRange():(i=y(t.win.document).createTextRange(),i.collapse(!0));t.docSelection.type==a?tt(t):gt(i)?ci(t,i):v(t)};else if(l(u,"getRangeAt")&&typeof u.rangeCount==lt)ct=function(t){if(s&&o&&t.docSelection.type==a)tt(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var i=0,r=t.rangeCount;i<r;++i)t._ranges[i]=new n.WrappedRange(t.nativeSelection.getRangeAt(i));nt(t,t._ranges[t.rangeCount-1],it(t.nativeSelection));t.isCollapsed=ut(t)}else v(t)};else if(w&&typeof u.isCollapsed==ri&&typeof oi.collapsed==ri&&r.implementsDomRange)ct=function(n){var t,i=n.nativeSelection;i.anchorNode?(t=st(i,0),n._ranges=[t],n.rangeCount=1,ki(n),n.isCollapsed=ut(n)):v(n)};else return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;i.refresh=function(n){var i=n?this._ranges.slice(0):null,r=this.anchorNode,u=this.anchorOffset,t;if(ct(this),n){if((t=i.length,t!=this._ranges.length)||this.anchorNode!=r||this.anchorOffset!=u)return!0;while(t--)if(!vt(i[t],this._ranges[t]))return!0;return!1}};ii=function(n,t){var r=n.getAllRanges(),i,u;for(n.removeAllRanges(),i=0,u=r.length;i<u;++i)vt(t,r[i])||n.addRange(r[i]);n.rangeCount||v(n)};i.removeRange=s&&o?function(n){var t,o;if(this.docSelection.type==a){var i=this.docSelection.createRange(),s=dt(n),h=e(i.item(0)),r=y(h).createControlRange(),u,f=!1;for(t=0,o=i.length;t<o;++t)u=i.item(t),u!==s||f?r.add(i.item(t)):f=!0;r.select();tt(this)}else ii(this,n)}:function(n){ii(this,n)};!p&&w&&r.implementsDomRange?(it=ei,i.isBackward=function(){return it(this)}):it=i.isBackward=function(){return!1};i.isBackwards=i.isBackward;i.toString=function(){for(var t=[],n=0,i=this.rangeCount;n<i;++n)t[n]=""+this._ranges[n];return t.join("")};i.collapse=function(t,i){yi(this,t);var r=n.createRange(t);r.collapseToPoint(t,i);this.setSingleRange(r);this.isCollapsed=!0};i.collapseToStart=function(){if(this.rangeCount){var n=this._ranges[0];this.collapse(n.startContainer,n.startOffset)}else throw new rt("INVALID_STATE_ERR");};i.collapseToEnd=function(){if(this.rangeCount){var n=this._ranges[this.rangeCount-1];this.collapse(n.endContainer,n.endOffset)}else throw new rt("INVALID_STATE_ERR");};i.selectAllChildren=function(t){yi(this,t);var i=n.createRange(t);i.selectNodeContents(t);this.setSingleRange(i)};i.deleteFromDocument=function(){var t,r,n,i,u;if(s&&o&&this.docSelection.type==a){for(t=this.docSelection.createRange();t.length;)r=t.item(0),t.remove(r),f.removeNode(r);this.refresh()}else if(this.rangeCount&&(n=this.getAllRanges(),n.length)){for(this.removeAllRanges(),i=0,u=n.length;i<u;++i)n[i].deleteContents();this.addRange(n[u-1])}};i.eachRange=function(n,t){for(var i=0,r=this._ranges.length;i<r;++i)if(n(this.getRangeAt(i)))return t};i.getAllRanges=function(){var n=[];return this.eachRange(function(t){n.push(t)}),n};i.setSingleRange=function(n,t){this.removeAllRanges();this.addRange(n,t)};i.callMethodOnEachRange=function(n,t){var i=[];return this.eachRange(function(r){i.push(r[n].apply(r,t||[]))}),i};i.setStart=pi(!0);i.setEnd=pi(!1);n.rangePrototype.select=function(n){ht(this.getDocument()).setSingleRange(this,n)};i.changeEachRange=function(n){var t=[],i=this.isBackward();this.eachRange(function(i){n(i);t.push(i)});this.removeAllRanges();i&&t.length==1?this.addRange(t[0],"backward"):this.setRanges(t)};i.containsNode=function(n,t){return this.eachRange(function(i){return i.containsNode(n,t)},!0)||!1};i.getBookmark=function(n){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[n])}};i.moveToBookmark=function(t){for(var i=[],f=0,u,r;u=t.rangeBookmarks[f++];)r=n.createRange(this.win),r.moveToBookmark(u),i.push(r);t.backward?this.setSingleRange(i[0],"backward"):this.setRanges(i)};i.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}};i.restoreRanges=function(n){this.removeAllRanges();for(var t=0,i;i=n.ranges[t];++t)this.addRange(i,n.backward&&t==0)};i.toHtml=function(){var n=[];return this.eachRange(function(t){n.push(k.toHtml(t))}),n.join("")};r.implementsTextRange&&(i.getNativeTextRange=function(){var r,i;if(r=this.docSelection){if(i=r.createRange(),gt(i))return i;throw t.createError("getNativeTextRange: selection is a control selection");}else{if(this.rangeCount>0)return n.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw t.createError("getNativeTextRange: selection contains no range");}});i.getName=function(){return"WrappedSelection"};i.inspect=function(){return wi(this)};i.detach=function(){ni(this.win,"delete");ai(this)};h.detachAll=function(){ni(null,"deleteAll")};h.inspect=wi;h.isDirectionBackward=yt;n.Selection=h;n.selectionPrototype=i;n.addShimListener(function(n){typeof n.getSelection=="undefined"&&(n.getSelection=function(){return ht(n)});n=null})}),d=!1,v=function(){d||(d=!0,!n.initialized&&n.config.autoInitialize&&k())},i&&(document.readyState=="complete"?v():(t(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",v,!1),h(window,"load",v))),n},this);