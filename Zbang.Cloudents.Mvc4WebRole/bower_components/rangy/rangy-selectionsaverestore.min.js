(function(n,t){typeof define=="function"&&define.amd?define(["./rangy-core"],n):typeof module!="undefined"&&typeof exports=="object"?module.exports=n(require("rangy")):n(t.rangy)})(function(n){return n.createModule("SaveRestore",["WrappedRange"],function(n,t){function i(n,t){return(t||document).getElementById(n)}function f(n,t){var f="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),i,r=e.getDocument(n.startContainer),u=n.cloneRange();return u.collapse(t),i=r.createElement("span"),i.id=f,i.style.lineHeight="0",i.style.display="none",i.className="rangySelectionBoundary",i.appendChild(r.createTextNode(v)),u.insertNode(i),i}function s(n,u,f,e){var o=i(f,n);o?(u[e?"setStartBefore":"setEndBefore"](o),r(o)):t.warn("Marker element has been removed. Cannot restore selection.")}function y(n,t){return t.compareBoundaryPoints(n.START_TO_START,n)}function h(t,i){var u,r,e=n.DomRange.getRangeDocument(t),s=t.toString(),h=o(i);return t.collapsed?(r=f(t,!1),{document:e,markerId:r.id,collapsed:!0}):(r=f(t,!1),u=f(t,!0),{document:e,startMarkerId:u.id,endMarkerId:r.id,collapsed:!1,backward:h,toString:function(){return"original text: '"+s+"', new text: '"+t.toString()+"'"}})}function c(u,f){var c=u.document,e,o,h;return typeof f=="undefined"&&(f=!0),e=n.createRange(c),u.collapsed?(o=i(u.markerId,c),o?(o.style.display="inline",h=o.previousSibling,h&&h.nodeType==3?(r(o),e.collapseToPoint(h,h.length)):(e.collapseBefore(o),r(o))):t.warn("Marker element has been removed. Cannot restore selection.")):(s(c,e,u.startMarkerId,!0),s(c,e,u.endMarkerId,!1)),f&&e.normalizeBoundaries(),e}function l(t,r){var e=[],f,s,l=o(r),u,c;for(t=t.slice(0),t.sort(y),u=0,c=t.length;u<c;++u)e[u]=h(t[u],l);for(u=c-1;u>=0;--u)f=t[u],s=n.DomRange.getRangeDocument(f),f.collapsed?f.collapseAfter(i(e[u].markerId,s)):(f.setEndBefore(i(e[u].endMarkerId,s)),f.setStartAfter(i(e[u].startMarkerId,s)));return e}function p(i){if(!n.isSelectionValid(i))return t.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var r=n.getSelection(i),u=r.getAllRanges(),f=u.length==1&&r.isBackward(),e=l(u,f);return f?r.setSingleRange(u[0],f):r.setRanges(u),{win:i,rangeInfos:e,restored:!1}}function a(n){for(var i=[],r=n.length,t=r-1;t>=0;t--)i[t]=c(n[t],!0);return i}function w(t,i){if(!t.restored){var r=t.rangeInfos,u=n.getSelection(t.win),f=a(r),e=r.length;e==1&&i&&n.features.selectionHasExtend&&r[0].backward?(u.removeAllRanges(),u.addRange(f[0],!0)):u.setRanges(f);t.restored=!0}}function u(n,t){var u=i(t,n);u&&r(u)}function b(n){for(var r=n.rangeInfos,i=0,f=r.length,t;i<f;++i)t=r[i],t.collapsed?u(n.doc,t.markerId):(u(n.doc,t.startMarkerId),u(n.doc,t.endMarkerId))}var e=n.dom,r=e.removeNode,o=n.Selection.isDirectionBackward,v="﻿";n.util.extend(n,{saveRange:h,restoreRange:c,saveRanges:l,restoreRanges:a,saveSelection:p,restoreSelection:w,removeMarkerElement:u,removeMarkers:b})}),n},this);