<?xml version="1.0" encoding="utf-8" ?>

<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                   assembly="Zbang.Zbox.Domain"
                   namespace="Zbang.Zbox.Domain">

  <class name="Box" abstract="true" table="Box" discriminator-value="Abstract">
    <id name="Id" column="BoxId" type="long">
      <generator class="native"></generator>
    </id>
    <discriminator column="Discriminator" not-null="false" type="Zbang.Zbox.Infrastructure.Enums.BoxType, Zbang.Zbox.Infrastructure" />

    <property name="Name" column="BoxName" not-null="true" length="120"/>
    <property name="Url" />
    <component name="UserTime" class="UserTimeDetails">
      <property name="CreationTime" not-null="true" insert="true" update="false" />
      <property name="UpdateTime"  not-null="true" insert="true"  />
      <property name="CreatedUser"  not-null="true" insert="true"  update="false"/>
      <property name="UpdatedUser"  not-null="true" insert="true"/>
    </component>

    <component name="PrivacySettings" class="PrivacySettings">
      <property name="PrivacySetting" not-null="true"/>
    </component>


    <property name="IsDeleted"/>
    <property name="IsDirty" />
    <many-to-one name="Owner" class="User" column="OwnerId" not-null="true" foreign-key="ownerIdBoxes"/>

    <set name="UserBoxRelationship"  cascade="all-delete-orphan" lazy="true" inverse="true" batch-size="20">
      <key column="BoxId"/>
      <one-to-many class="UserBoxRel"/>
    </set>

    <bag name="Items"  cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="BoxId"/>
      <one-to-many class="Item"/>
    </bag>
    <bag name="Quizzes"  cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="BoxId"/>
      <one-to-many class="Quiz"/>
    </bag>
    <bag name="Flashcards"  cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="BoxId"/>
      <one-to-many class="FlashcardMeta"/>
    </bag>
    <bag name="ItemTabs"  cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="BoxId"/>
      <one-to-many class="ItemTab"/>
    </bag>

    
    <bag name="Comments" cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="BoxId" />
      <one-to-many class="Comment"/>
    </bag>
    <bag name="Replies" cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="BoxId" />
      <one-to-many class="CommentReply"/>
    </bag>

    <bag name="Updates" cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="BoxId" />
      <one-to-many class="Updates"/>
    </bag>

    <bag name="Invites" cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="BoxId" foreign-key="InviteBoxBoxId" />
      <one-to-many class="InviteToBox"/>
    </bag>
    
    <property name="MembersCount" >
      <column name="MembersCount" default="0" not-null="true"/>
    </property>
    <property name="ItemCount">
      <column name="ItemCount" default="0" not-null="true"/>
    </property>
    <property name="CommentCount">
      <column name="CommentCount" default="0" not-null="true"/>
    </property>
    <property name="QuizCount" />
    <property name="FlashcardCount" />


    <subclass name="PrivateBox" discriminator-value="null">
      
    </subclass>
    <subclass name="AcademicBox" discriminator-value="Academic">
      <property name="CourseCode"/>
      <property name="Professor" column="ProfessorName"/>
      <many-to-one name="Department" column="LibraryId" class="Library" not-null="false" foreign-key="LibraryBoxes3"/>
      <!--<many-to-one name="Department" class="Department" not-null="false" foreign-key="DepartmentBoxes"/>-->
      <many-to-one name="University" class="University" not-null="false" foreign-key="UniversityBoxes"/>
      
      <subclass name="AcademicBoxClosed" discriminator-value="AcademicClosed">
        <many-to-one name="ParentDepartment" column="LibraryParentId" class="Library" not-null="false" foreign-key="LibraryBoxes4"/>
        <property name="ParentDepartmentId" column="LibraryParentId" insert="false" update="false" />
      </subclass>  
    </subclass>

    
  </class>
  <query name="UpdateItemToDirty">
    <![CDATA[
    update Item i set IsDirty = 1 where i.Box = :boxId and i.IsDeleted = 0
    ]]>
  </query>
  <query name="UpdateFlashcardToDirty">
    <![CDATA[
    update FlashcardMeta i set IsDirty = 1 where i.Box = :boxId and i.IsDeleted = 0
    ]]>
  </query>
  <query name="UpdateQuizToDirty">
    <![CDATA[
    update Quiz i set IsDirty = 1 where i.Box = :boxId and i.IsDeleted = 0
    ]]>
  </query>
</hibernate-mapping>