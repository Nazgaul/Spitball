<?xml version="1.0" encoding="utf-8" ?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                   assembly="Zbang.Zbox.Domain"
                   namespace="Zbang.Zbox.Domain">
  <class name="Library">
    <id name="Id" column="LibraryId">
      <generator class="assigned"/>
    </id>
    <property name="Name" not-null="true"/>
    <property name="AmountOfNodes" column="AmountOfChildren" not-null="true"/>
    <property name="NoOfBoxes" column="NoOfBoxes" not-null="true"/>
    <property name="Url" column="Url" not-null="true"/>
    <property name="HierarchyId"
              type="Zbang.Zbox.Infrastructure.Data.Types.HierarchyId,  Zbang.Zbox.Infrastructure.Data" >
      <column name="level" not-null="true" sql-type="hierarchyid" />
    </property>
    
    <many-to-one name="Parent" class="Library" column="ParentId" foreign-key="LibraryParent"  />
    <many-to-one update="false" name="University" class="University" column="Id" not-null="true" foreign-key="LibraryUniversity2"/>
    <many-to-one update="false" name="CreatedUser" class="User" column="UserId" not-null="true" foreign-key="LibraryUser"/>
    <property name="Settings" not-null="true"/>

    <bag name="Children" cascade="all-delete-orphan" inverse="false" lazy="true" >
      <key column="ParentId" foreign-key="LibraryParentId"/>
      <one-to-many class="Library"/>
    </bag>

    <bag name="Boxes" cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="LibraryId" foreign-key="LibraryBoxes3"/>
      <one-to-many class="Box"/>
     
    </bag>
    <set name="UserLibraryRelationship"  cascade="all-delete-orphan" lazy="true" inverse="true" batch-size="20">
      <key column="LibraryId"/>
      <one-to-many class="UserLibraryRel"/>
    </set>
</class>
  <query name="updateItem">
    <![CDATA[
    update Item set IsDirty = 1
    where BoxId in ( select Id from AcademicBoxClosed where  ParentDepartmentId = :depId )
    ]]>
  </query>
  <query name="updateQuiz">
    <![CDATA[
    update Quiz set IsDirty = 1
    where BoxId in ( select Id from AcademicBoxClosed where  ParentDepartmentId = :depId )
    ]]>
  </query>
  <query name="updateBox">
    <![CDATA[
    update AcademicBoxClosed set isdirty = 1
    where ParentDepartmentId = :depId
    ]]>
  </query>
</hibernate-mapping>