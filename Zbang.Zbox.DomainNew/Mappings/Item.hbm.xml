<?xml version="1.0" encoding="utf-8" ?>

<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                   assembly="Zbang.Zbox.Domain"
                   namespace="Zbang.Zbox.Domain">
  <class name="Item" table="Item" >
    <id name="Id" type="long" column="ItemId">
      <generator class="native"/>
    </id>
    <discriminator column="Discriminator" not-null="true" type="System.String" />
    <property name="Name" length="4000"/>
    <property name="IsDeleted" index="iBoxIsDeleted"/>
    <property name="IsDirty" />

    <property name="Size"/>
    <property name="NumberOfViews"/>
    <component name="DateTimeUser" class="UserTimeDetails">
      <property name="CreationTime" insert="true" update="false">
        <column name="CreationTime" not-null="true" sql-type="datetime2(2)"/>
      </property>
      <property name="UpdateTime"  insert="true">
        <column name="UpdateTime" not-null="true" sql-type="datetime2(2)" />
      </property>
      <property name="CreatedUser"  not-null="true" insert="true" update="false"/>
      <property name="UpdatedUser"  not-null="true" insert="true" />
    </component>
    <many-to-one column="BoxId" class="Box" name="Box" index="iBoxIsDeleted"/>
    <many-to-one column="CourseTag" class="CourseTag" name="CourseTag" foreign-key="iCourseTag"/>
    <property  name="BoxId" column="BoxId" insert="false" update="false" />

    <many-to-one name="User" class="User" column="UserId" not-null="true"/>
    <property  name="UploaderId" column="UserId" insert="false" update="false" />

    <many-to-one column="QuestionId" class="Comment" name="Comment" />
    <many-to-one column="AnswerId" class="CommentReply" name="CommentReply"/>
    <many-to-one column="ItemTabId" class="ItemTab" name="Tab"/>

    <property name="ItemContentUrl" column="BlobName"/>

    <property name="LikeCount"/>
    <property name="Url" length="4000"/>
    <property name="Language"/>
    <set name="ItemTags" inverse="true" lazy="true">
      <key column="ItemId" foreign-key="fTagItemItem"/>
      <one-to-many class="ItemTag"/>
    </set>
    <bag name="ItemRates"  cascade="all-delete-orphan" inverse="true" lazy="true">
      <key column="ItemId"/>
      <one-to-many class="ItemRate"/>
    </bag>
    <bag name="Updates" inverse="true" lazy="true" cascade="delete-orphan" >
      <key column="ItemId" foreign-key="NewUpdatesItem"/>
      <one-to-many class="Updates"/>
    </bag>

    <bag name="ItemComments" inverse="true" lazy="true" cascade="delete-orphan" >
      <key column="ItemId" foreign-key="itemIdItemComment"/>
      <one-to-many class="ItemComment"/>
    </bag>
    <bag name="ItemReplies" inverse="true" lazy="true" cascade="delete-orphan" >
      <key column="ItemId" foreign-key="itemIdItemReply"/>
      <one-to-many class="ItemCommentReply"/>
    </bag>



    <subclass name="Link" discriminator-value="Link">
    </subclass>
    <subclass name="File" discriminator-value="File">
      <property name="NumberOfDownloads"/>
      <property name="Md5"/>
      <property name="PreviewFailed"/>
      <property name="Content" type="string" length="500" />
     


    </subclass>
  </class>
  <!--<query name="ItemWithNoSize">
    <![CDATA[
       select f.id from File f 
       where f.Size < 1 
       and f.IsDeleted = 0
    ]]>
  </query>-->
  <database-object>
    <create>
      CREATE NONCLUSTERED INDEX [iUserIsDeleted] ON [Zbox].[Item] ([IsDeleted],[UserId])
    </create>
    <drop></drop>
  </database-object>
</hibernate-mapping>
