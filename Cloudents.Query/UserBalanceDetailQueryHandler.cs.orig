using Cloudents.Core.DTOs;
using Cloudents.Core.Entities;
using Cloudents.Core.Enum;
using NHibernate;
using NHibernate.Linq;
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Globalization;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
<<<<<<< HEAD
using Cloudents.Core.DTOs;
using Cloudents.Core.Entities;
using Cloudents.Core.Enum;
using Cloudents.Core.Extension;
using Cloudents.Core.Interfaces;
using NHibernate;
using NHibernate.Linq;
=======
>>>>>>> origin/develop

namespace Cloudents.Query
{
    public class UserBalanceQuery : IQuery<IEnumerable<BalanceDto>>
    {
        public UserBalanceQuery(long id)
        {
            Id = id;
        }

        private long Id { get; }




        [SuppressMessage("ReSharper", "UnusedMember.Global", Justification = "Ioc inject")]
        internal sealed class UserBalanceDetailQueryHandler : IQueryHandler<UserBalanceQuery, IEnumerable<BalanceDto>>
        {

            private readonly IStatelessSession _statelessSession;

            public UserBalanceDetailQueryHandler(QuerySession session)
            {
                _statelessSession = session.StatelessSession;
            }

            public async Task<IEnumerable<BalanceDto>> GetAsync(UserBalanceQuery query, CancellationToken token)
            {
                var listOfQueries = new Dictionary<TransactionType, IFutureValue<decimal?>>(); //List<IFutureValue<decimal>>();

                foreach (var value in Enum.GetValues(typeof(TransactionType)))
                {
                    var type = (TransactionType)value;
                    var xx = _statelessSession.Query<Transaction>()
                         .Where(w => w.User.Id == query.Id && w.Type == type)
                         .GroupBy(g => 1)
                         //.Select(s=>s.Key)
                         .Select(s => s.Sum(x => (decimal?)x.Price))
                         .ToFutureValue();
                    listOfQueries.Add(type, xx);
                }

                var futureValueCountry = _statelessSession.Query<User>().Where(w => w.Id == query.Id).Select(s => s.Country).ToFutureValue();


                Country country = await futureValueCountry.GetValueAsync(token);
<<<<<<< HEAD
                var culture = CultureInfo.CurrentCulture.ChangeCultureBaseOnCountry(country.Name);
=======
>>>>>>> origin/develop

                var retVal = listOfQueries.Select(s =>
                {
                   var dbVal = s.Value.Value;
<<<<<<< HEAD

                   var currencyValue = (country.ConversationRate * dbVal.GetValueOrDefault()).ToString("C", culture);
                   return new BalanceDto(s.Key.ToString("G"), dbVal.GetValueOrDefault(), currencyValue);
=======
>>>>>>> origin/develop

                   var currencyValue = (country.ConversationRate * dbVal.GetValueOrDefault());
                   return new BalanceDto(s.Key.ToString("G"), dbVal.GetValueOrDefault(), currencyValue, country.RegionInfo.ISOCurrencySymbol);

                }).ToList();

                var totalBalance = retVal.Sum(x => x.Points);
<<<<<<< HEAD
                var totalCurrencyValue = (country.ConversationRate * totalBalance).ToString("C", culture);
                retVal.Add(new BalanceDto("Total", totalBalance, totalCurrencyValue));
=======
                var totalCurrencyValue = (country.ConversationRate * totalBalance);
                retVal.Add(new BalanceDto("Total", totalBalance, totalCurrencyValue, country.RegionInfo.ISOCurrencySymbol));
>>>>>>> origin/develop

                return retVal;
            }
        }
    }
}